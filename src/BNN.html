<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="BNN_Comb.js"></script>
  <script src="transit.js"></script>
  <script src="significator.js"></script>
  <script src="houseLord.js"></script>

  <title>BNN Trine Visualizer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }

    h1 {
      text-align: center;
    }

    .planet-input {
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    label {
      width: 110px;
    }

    select,
    input {
      padding: 5px;
    }

    #results {
      margin-top: 20px;
      padding: 10px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .chart {
      margin-top: 30px;
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
      justify-content: space-around;
    }

    .trine-chart {
      width: 20%;
      flex-grow: 0;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 10px;
      background: #fff;
    }

    .trine-chart h3 {
      margin-bottom: 10px;
    }

    .trine-chart ul {
      list-style: none;
      padding: 0;
    }

    .trine-chart li {
      margin: 5px 0;
    }

    .conj-result {
      margin-top: 10px;
      padding: 8px;
      border-left: 4px solid #0077cc;
      background: #f0f8ff;
    }

    #diamond-chart {
      margin-top: -564px;
      position: absolute;
      margin-left: 743px;
      zoom: 70%;
    }
  </style>
</head>

<body>
  <h1>BNN Trine & Aspect Visualizer</h1><br><br><br>
  <div id="inputForm"></div>
  <!-- Diamond Chart -->
  <div id="diamond-chart"></div>
  <button onclick="analyzeHoroscope()">Analyze</button>
  <!-- Jupiter Rotation Age Selector -->
  <div class="planet-input">
    <label>Jupiter Minor Progression</label>

    <label>Current Age</label>
    <select id="age-select">

    </select>
    <button onclick="calculateJupiterProgression()">Get Jupiters House</button>
    <button onclick="getJupiterMajorProgression()">Jupiters Major Progression</button>

  </div>
  <br>
  <div>
    <label>Saturn's Progression</label>
    <button onclick="calculateSaturnProgression()">Get Saturn's House</button>
    <button onclick="getSaturnMajorProgression()">Saturn Major Progression</button>
  </div>
  <div>
    <label>Rahu's Progression</label>
    <button onclick="calculateRahuProgression()">Get Rahu's House</button>
    <button onclick="getRahuMajorProgression()">Rahu Major Progression</button>
  </div>

  <!-- Conjunction checker -->
  <div class="planet-input" style="margin-top:20px">
    <label>Check Conjunction</label>
    <select id="conj-p1">
      <option value="">--Select Planet 1--</option>
    </select>
    <select id="conj-p2">
      <option value="">--Select Planet 2--</option>
    </select>
    <button onclick="checkConjunction()">Check</button>
  </div>
  <div class="planet-input" style="margin-top:20px">
    <label>Jupiter Transit Sign</label>
    <select id="transit-jupiter-sign">
    </select>
    <label>Saturn Transit Sign</label>
    <select id="transit-saturn-sign">
    </select>
    <button onclick="analyzeTransits()">Analyze Transit Effects</button>
  </div>
  <div id="results"></div>

  <script>
    /* ---------- CONFIG ---------- */
    const signs = [
      "Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo",
      "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"
    ];

    const planets = [
      "Sun", "Moon", "Mars", "Mercury", "Venus", "Jupiter", "Saturn", "Rahu", "Ketu"
    ];

    document.getElementById('age-select').innerHTML = `${[...Array(100).keys()].map(i => `<option value="${i + 1}">${i + 1} years</option>`).join('')}`;

    document.getElementById('transit-jupiter-sign').innerHTML = `${signs.map((s, i) => `<option value="${i + 1}">${s}</option>`).join('')}`;

    document.getElementById('transit-saturn-sign').innerHTML = `${signs.map((s, i) => `<option value="${i + 1}">${s}</option>`).join('')}`;

    /* ---------- LOAD COMBINATION DATA ---------- 
    let combinationData = [];
    fetch('BNN_Comb.json')
      .then(res => res.json())
      .then(data => combinationData = data)
      .catch(() => alert('Failed to load combination data. Predictions may be unavailable.'));
  */
    /* ---------- BUILD INPUT FORM ---------- */
    const formDiv = document.getElementById("inputForm");
    planets.forEach(planet => {
      const div = document.createElement("div");
      div.className = "planet-input";
      div.innerHTML = `
      <label>${planet}</label>
      <select id="${planet}-sign">
        ${signs.map((s, i) => `<option value="${i + 1}">${s} - ${i + 1}</option>`).join('')}
      </select>
      <input id="${planet}-deg" type="number" min="0" max="29.99" step="0.01" placeholder="Degree (0-29.99)" />
	  <select id="${planet}-house">
        ${[...Array(12).keys()].map(i => `<option value="${i + 1}">${i + 1} House</option>`).join('')}
      </select>
      <input id="${planet}-retrograde" type="checkbox" />
    `;
      formDiv.appendChild(div);
    });

    /* Populate conjunction dropdowns */
    const conjP1Sel = document.getElementById('conj-p1');
    const conjP2Sel = document.getElementById('conj-p2');
    planets.forEach(p => {
      const opt1 = new Option(p, p);
      const opt2 = new Option(p, p);
      conjP1Sel.add(opt1);
      conjP2Sel.add(opt2);
    });
    var nativeHoroscope = {};
    /* ---------- ANALYZE HOROSCOPE ---------- */
    function analyzeHoroscope() {
      const horoscope = {};
      planets.forEach(p => {
        const sign = parseInt(document.getElementById(`${p}-sign`).value);
        const degree = parseFloat(document.getElementById(`${p}-deg`).value);
        const house = parseInt(document.getElementById(`${p}-house`).value);
        const retrograde = document.getElementById(`${p}-retrograde`)?.checked || false;
        if (!isNaN(degree)) {
          horoscope[p] = { sign, degree, house, retrograde };
        }
      });
      nativeHoroscope = horoscope;
      console.log('Native Horoscope:', horoscope);
      const result = getTrineGroupsWithBNNAspects(horoscope);
      const parivartans = detectParivartan(horoscope);
      renderResults(result, parivartans);
      renderDiamondChart(horoscope);
      getMarriageOutcomeForFemale(horoscope);
      getMarriageOutcomeForMale(horoscope);
      interpretAllConjunctions(horoscope, property);
      showSignLordPlacements(horoscope);
      showProfessionFromHoroscope(horoscope);
      getWorkEnvironmentFromHoroscope(horoscope);
      displayChildHealthPredictions(horoscope, getChildBirthHealthPredictions);
      determineSunPredictions(horoscope);
      predictMoonFromJupiter(horoscope);
      getMoonRashiPredictions(horoscope);
      getSaturnFromJupiterPredictions(horoscope);
    }

    /* ---------- CORE LOGIC: TRINES, ASPECTS & PREDICTIONS ---------- */
    function getTrineGroupsWithBNNAspects(horoscope) {
      const trineMap = {
        '1': [1, 5, 9],
        '2': [2, 6, 10],
        '3': [3, 7, 11],
        '4': [4, 8, 12]
      };

      const signToTrineKey = {};
      Object.entries(trineMap).forEach(([k, arr]) => arr.forEach(s => signToTrineKey[s] = k));

      const trineGroups = { '1': [], '2': [], '3': [], '4': [] };

      const allPlanets = [];

      for (const [planet, { sign, degree }] of Object.entries(horoscope)) {
        const key = signToTrineKey[sign];
        const absDegree = (sign - 1) * 30 + degree;
        const data = { planet, sign, degree, absDegree };
        allPlanets.push(data);
        trineGroups[key].push(data);
      }

      for (const k in trineGroups) {
        trineGroups[k].sort((a, b) => a.absDegree - b.absDegree);
      }
      console.log('Trine Groups:', trineGroups);
      const result = {};
      for (const k in trineGroups) {
        const group = [...trineGroups[k]];
        const conjunctions = [];
        const aspects = [];
        const predictions = [];

        // Include planets in 2nd, 12th, and 7th from each trine member
        /* */
        const signsInGroup = new Set(trineMap[k]);
        group.forEach(({ sign, absDegree }) => {
          const second = (sign % 12) + 1;
          const twelfth = ((sign + 10 - 1) % 12) + 1;
          const seventh = ((sign + 6 - 1) % 12) + 1;

          const nearbySigns = [second, twelfth, seventh];
          allPlanets.forEach(p => {
            if (nearbySigns.includes(p.sign) && !signsInGroup.has(p.sign)) {
              group.push(p);
            }
          });
        });

        // Deduplicate and sort again
        const uniqueMap = {};
        group.forEach(p => uniqueMap[p.planet] = p);
        const uniqueGroup = Object.values(uniqueMap).sort((a, b) => a.absDegree - b.absDegree);
        /* Old Logic
            for (let i = 0; i < uniqueGroup.length; i++) {
              for (let j = i + 1; j < uniqueGroup.length; j++) {
                const p1 = uniqueGroup[i].planet;
                const p2 = uniqueGroup[j].planet;
                if (uniqueGroup[i].sign === uniqueGroup[j].sign && Math.abs(uniqueGroup[i].degree - uniqueGroup[j].degree) <= 3) {
                  conjunctions.push({ pair: [p1, p2], sign: uniqueGroup[i].sign, degrees: [uniqueGroup[i].degree, uniqueGroup[j].degree] });
                }
                aspects.push({ from: p1, to: p2, note: `${p1} influences ${p2}` });
      
                const combo = findCombination(p1, p2);
                //if (combo) predictions.push(...combo.predictions);
            if (combo) combo.predictions.forEach(pr => predictions.push(`${p1} & ${p2}: ${pr}`));
      
              }
            }
          */
        for (let i = 0; i < uniqueGroup.length; i++) {
          for (let j = i + 1; j < uniqueGroup.length; j++) {
            const g1 = uniqueGroup[i];
            const g2 = uniqueGroup[j];
            const p1 = g1.planet;
            const p2 = g2.planet;

            if (g1.sign === g2.sign) {
              conjunctions.push({ pair: [p1, p2], sign: g1.sign, degrees: [g1.degree, g2.degree] });
            }
            console.log("Checking if ", g1.degree, "<", g2.degree);
            if (g1.degree < g2.degree) {
              aspects.push({ from: p1, to: p2, note: `${p1} influences ${p2}` });
              const combo = findCombination(p1, p2);
              if (combo) {
                const key = `${p1} & ${p2}`;
                combo.predictions.forEach(pr => predictions.push(`${p1} & ${p2}: ${pr}`));
                //if (!predictions[key]) predictions[key] = [];
                //combo.predictions.forEach(pr => predictions[key].push(pr));
              }
            }
          }
        }

        // 2. NEW: All pairs of planets in the same trine (using signsInGroup), irrespective of degree or sign
        const trinePlanets = uniqueGroup.filter(p => signsInGroup.has(p.sign));
        for (let i = 0; i < trinePlanets.length; i++) {
          for (let j = i + 1; j < trinePlanets.length; j++) {
            const p1 = trinePlanets[i].planet;
            const p2 = trinePlanets[j].planet;
            // Skip if already handled above (same sign)
            if (trinePlanets[i].sign !== trinePlanets[j].sign) {
              const combo = findCombination(p1, p2);
              if (combo) {
                combo.predictions.forEach(pr => predictions.push(`[Trine] ${p1} & ${p2}: ${pr}`));
              }
            }
          }
        }


        result[k] = {
          trineSigns: trineMap[k],
          planets: uniqueGroup,
          conjunctions,
          aspects,
          predictions: [...new Set(predictions)]
        };
      }

      return result;
    }

    /* Utility to find combination irrespective of order */
    function findCombination(p1, p2) {
      return combinationData.find(c =>
        (c.planets[0] === p1 && c.planets[1] === p2) ||
        (c.planets[0] === p2 && c.planets[1] === p1)
      );
    }

    /* ---------- RENDER RESULTS ---------- */
    function renderResults(data, parivartans) {
      const div = document.getElementById("results");
      div.innerHTML = `<h2>Results</h2>`;
      const chart = document.createElement("div");
      chart.className = "chart";

      for (const k in data) {
        const g = data[k];
        const container = document.createElement("div");
        container.className = "trine-chart";
        container.innerHTML = `
        <h3>Trine: ${g.trineSigns.join("-")}</h3>
        <strong>Planets:</strong>
        <ul>${g.planets.map(p => `<li>${p.planet}: Sign ${p.sign}, ${p.degree.toFixed(2)}°</li>`).join('')}</ul>
        ${g.conjunctions.length ? `<strong>Conjunctions:</strong><ul>${g.conjunctions.map(c => `<li>${c.pair.join(' & ')} in Sign ${c.sign}</li>`).join('')}</ul>` : ''}
        ${g.aspects.length ? `<strong>Aspects:</strong><ul>${g.aspects.map(a => `<li>${a.note}</li>`).join('')}</ul>` : ''}
        ${g.predictions.length ? `<strong>Predictions:</strong><ul>${g.predictions.map(p => `<li>${p}</li>`).join('')}</ul>` : ''}
      `;
        chart.appendChild(container);
      }
      div.appendChild(chart);
      if (parivartans.length) {
        const pDiv = document.createElement('div');
        pDiv.innerHTML = `<h3>Parivartan Yogas Detected:</h3><ul>${parivartans.map(p => `<li><strong>${p}</strong></li>`).join('')}</ul>`;
        div.appendChild(pDiv);
      }
      else {
        const pDiv = document.createElement('div');
        pDiv.innerHTML = `<h3>No Parivartan Yogas Detected:</h3>`;
        div.appendChild(pDiv);
      }
    }

    /* ---------- CONJUNCTION CHECKER ---------- */
    function checkConjunction() {
      const p1 = document.getElementById("conj-p1").value;
      const p2 = document.getElementById("conj-p2").value;
      if (!p1 || !p2 || p1 === p2) {
        alert("Please select two different planets.");
        return;
      }

      const d1 = parseFloat(document.getElementById(`${p1}-deg`).value);
      const d2 = parseFloat(document.getElementById(`${p2}-deg`).value);
      const s1 = parseInt(document.getElementById(`${p1}-sign`).value);
      const s2 = parseInt(document.getElementById(`${p2}-sign`).value);

      if (isNaN(d1) || isNaN(d2)) {
        alert("Please enter valid degrees for both planets.");
        return;
      }

      const resultDiv = document.getElementById("results");
      // Find predictions for this pair
      const combo = findCombination(p1, p2);
      let predHTML = '';
      if (combo && combo.predictions && combo.predictions.length) {
        predHTML = '<strong>Predictions:</strong><ul>' + combo.predictions.map(pr => `<li>${pr}</li>`).join('') + '</ul>';
        areConjunct = true;
      } else {
        predHTML = '<p><em>No specific predictions found for this combination.</em></p>';
        areConjunct = false;
      }

      const html = `
      <div class="conj-result">
        <p><strong>${p1} &amp; ${p2}</strong> ${areConjunct ? 'are' : 'are not'} in conjunction.</p>
        ${predHTML}
      </div>`;

      document.getElementById('results').insertAdjacentHTML('afterbegin', html);
    }
    // Function to calculate Saturn's minor progression considering saturn's slow movement takes 2.5 years to move 1 sign
    function calculateSaturnProgression() {
      const saturnSign = parseInt(document.getElementById('Saturn-sign').value);
      const saturnHouse = parseInt(document.getElementById('Saturn-house').value);
      const age = parseInt(document.getElementById('age-select').value);

      if (isNaN(saturnSign)) {
        alert('Please select Saturn sign');
        return;
      }

      const totalMonths = age * 12;
      // Saturn takes 2.5 years to move 1 sign, so we divide age by 2.5
      const progressedSign = ((saturnSign - 1 + Math.floor(age / 2.5)) % 12) + 1;
      const progressedHouse = ((saturnHouse - 1 + Math.floor(age / 2.5)) % 12) + 1;

      const result = `Age ${age} Saturn's minor progression is currently from House ${saturnHouse} --> ${progressedHouse} From Sign ${saturnSign} --> ${progressedSign} (Saturn's Final Sign: ${signs[progressedSign - 1]})`;

      const div = document.getElementById("results");
      div.insertAdjacentHTML('afterbegin', `<p><strong>${result}</strong></p>`);
    }

    // Function to calculate Rahu's minor progression considering rahu's slow movement takes 1.5 years to move 1 sign
    function calculateRahuProgression() {
      const rahuSign = parseInt(document.getElementById('Rahu-sign').value);
      const rahuHouse = parseInt(document.getElementById('Rahu-house').value);
      const age = parseInt(document.getElementById('age-select').value);
      if (isNaN(rahuSign)) {
        alert('Please select Rahu sign');
        return;
      }
      // Rahu takes 1.5 years to move 1 sign back, so we divide age by 1.5
      const retrogradeSteps = Math.floor(age / 1.5);
      // Always keep result in 1-12 range, never negative or zero
      let progressedSign = ((rahuSign - retrogradeSteps - 1 + 12 * 10) % 12) + 1;
      let progressedHouse = ((rahuHouse - retrogradeSteps - 1 + 12 * 10) % 12) + 1;
      const result = `Age ${age} Rahu's minor progression is currently from House ${rahuHouse} --> ${progressedHouse} From Sign ${rahuSign} -> ${progressedSign} (Rahu's Final Sign: ${signs[progressedSign - 1]})`;
      const div = document.getElementById("results");
      div.insertAdjacentHTML('afterbegin', `<p><strong>${result}</strong></p>`);
    }

    function calculateJupiterProgression() {
      const jupiterSign = parseInt(document.getElementById('Jupiter-sign').value);
      const jupiterHouse = parseInt(document.getElementById('Jupiter-house').value);
      const age = parseInt(document.getElementById('age-select').value);

      if (isNaN(jupiterSign)) {
        alert('Please select Jupiter sign');
        return;
      }
      console.log();
      const totalMonths = age * 12;
      //const progressedSign  = (jupiterSign  + age) < 13 ? jupiterSign  + age - 1 : ((jupiterSign  - 1 + age) % 12) + 1;
      //const progressedHouse = (jupiterHouse + age) < 13 ? jupiterHouse + age - 1 : ((jupiterHouse - 1 + age) % 12) + 1;
      const progressedSign = ((jupiterSign - 1 + age) % 12) == 0 ? jupiterSign : ((jupiterSign - 1 + age) % 12);
      const progressedHouse = ((jupiterHouse - 1 + age) % 12);

      const result = `Age ${age} Jupiter's minor progression is currently from House ${jupiterHouse} -> ${progressedHouse} From Sign ${jupiterSign} -> ${progressedSign} (Jupiter's Sign: ${signs[progressedSign - 1]})`;

      const div = document.getElementById("results");
      div.insertAdjacentHTML('afterbegin', `<p><strong>${result}</strong></p>`);
    }
    function detectParivartan(horoscope) {
      // Basic sign lordship map (assuming traditional rulerships)
      const signLords = {
        1: "Mars", 2: "Venus", 3: "Mercury", 4: "Moon", 5: "Sun", 6: "Mercury",
        7: "Venus", 8: "Mars", 9: "Jupiter", 10: "Saturn", 11: "Saturn", 12: "Jupiter"
      };

      const placements = {};
      for (const [planet, { sign }] of Object.entries(horoscope)) {
        if (!placements[sign]) placements[sign] = [];
        placements[sign].push(planet);
      }

      const parivartans = [];
      for (const [planet, { sign }] of Object.entries(horoscope)) {
        const lordOfThisSign = signLords[sign];
        const signOfThisPlanet = sign;
        const signOfLord = Object.entries(horoscope).find(([p, v]) => p === lordOfThisSign)?.[1]?.sign;
        const lordOfThatSign = signLords[signOfLord];

        if (planet === lordOfThatSign && planet !== lordOfThisSign) {
          const pair = [planet, lordOfThisSign].sort().join(" & ");
          if (!parivartans.find(p => p === pair)) {
            parivartans.push(pair);
          }
        }
      }

      return parivartans;
    }

    function createCyclicJSON(horoscope) {
      const cyclicHoroscope = {};
      //Get Sun's position and count signs from there and store in cyclicHoroscope
      const sunSign = horoscope['Sun']?.sign;
      const sunHouse = horoscope['Sun']?.house;
      if (!sunSign) return cyclicHoroscope;
      //Create a cyclic horoscope starting from Sun's sign with 1 based index
      for (let i = 0; i < 12; i++) {
        const signIndex = (sunSign - 1 + i) % 12 + 1;
        const houseIndex = (sunHouse - 1 + i) % 12 + 1;
        //signs[signIndex - 1]
        cyclicHoroscope[houseIndex] = {
          signid: signs[signIndex - 1],
          sign: signIndex, // 1 to 12
          // Will load planets in this sign from horoscope object which has sign, degree, house, retrograde
          // iterate over horoscope and map planets to cyclicHoroscope and return array having planets in that sign
          planets: []
        };
      }
      for (const [planet, { sign, degree, house, retrograde }] of Object.entries(horoscope)) {
        cyclicHoroscope[sign].planets.push(planet);
      }
      console.log('Cyclic Horoscope:', cyclicHoroscope);
      return cyclicHoroscope;
    }
    function renderDiamondChart(horoscope) {
      const housePlanets = Array.from({ length: 12 }, () => []);
      const fixedHouse = {};//Array.from({ length: 12 }, () => []);

      const ascendant = parseInt(document.getElementById('Ascendant-sign')?.value || '1');
      var idx = 1;
      for (const [planet, { sign, degree, house }] of Object.entries(horoscope)) {
        console.log('Redering Diamond Chart');
        console.log(sign, degree, house);
        housePlanets[sign - 1].push(`${planet} (${degree.toFixed(1)}°)`);

        if (fixedHouse.hasOwnProperty(house)) {
          fixedHouse[house].push(`${planet} (${degree.toFixed(1)}°) ${sign}`);
        }
        else {
          fixedHouse[house] = [];
          fixedHouse[house].push(`${planet} (${degree.toFixed(1)}°) ${sign}`);
        }
        idx++;
      }

      const layout = Array.from({ length: 12 }, (_, i) => ((ascendant + i - 1) % 12) + 1);
      const container = document.getElementById('diamond-chart');
      container.innerHTML = '<h2>Diamond Horoscope Chart</h2><img src="https://raw.githubusercontent.com/ShreeAura-Astrology/jwtPY/main/New-Kundli.png" width="700px" height="100%"/>';

      const diamond = document.createElement('div');
      diamond.style.position = 'relative';
      diamond.style.width = '694px';
      diamond.style.height = '482px';
      diamond.style.marginTop = '-498px';
      // diamond.style.background-image  = 'url(https://raw.githubusercontent.com/ShreeAura-Astrology/jwtPY/main/New-Kundli.png)';
      // diamond.style.background-repeat = 'no-repeat';

      const boxPositions = [
        { top: '23%', left: '45%' }, // 1
        { top: '10%', left: '19%' }, // 2
        { top: '18%', left: '3%' }, // 3
        { top: '41%', left: '18%' }, // 4
        { top: '69%', left: '1%' }, // 5
        { top: '90%', left: '16%' }, // 6
        { top: '70%', left: '45%' }, // 7
        { top: '90%', left: '70%' }, // 8
        { top: '70%', left: '88%' }, // 9 (center)
        { top: '40%', left: '70%' }, // 10
        { top: '14%', left: '87%' }, // 11
        { top: '3%', left: '70%' }  // 12
      ];
      const cyclicHoroscope = createCyclicJSON(horoscope);
      console.log(layout);
      layout.forEach((sign, i) => {
        const box = document.createElement('div');
        const planets = housePlanets[sign - 1].join('<br>');
        const allP = fixedHouse.hasOwnProperty(sign) ? fixedHouse[sign].join('<br>') : `${cyclicHoroscope[sign].sign}<br>`;
        box.innerHTML = `<strong>${allP}</strong>`;
        //box.innerHTML = `<strong>${allP}</strong><strong><br>${signs[sign - 1]}</strong><br>${planets}`;

        box.style.position = 'absolute';
        //box.style.width = '80px';
        //box.style.height = '60px';
        //box.style.border = '1px solid #999';
        box.style.fontSize = '15px';
        box.style.background = (sign === ascendant) ? '#ffffcc' : '#fff';
        box.style.textAlign = 'center';
        box.style.padding = '4px';
        //box.style.boxSizing = 'border-box';
        box.style.top = boxPositions[i].top;
        box.style.left = boxPositions[i].left;
        diamond.appendChild(box);
      });

      container.appendChild(diamond);
      createCyclicJSON(horoscope);
    }

    // Saturn's Major Progression
    function getSaturnMajorProgression() {
      const saturnSign = parseInt(document.getElementById('Saturn-sign').value);
      const saturnHouse = parseInt(document.getElementById('Saturn-house').value);
      const age = parseInt(document.getElementById('age-select').value);
      var outputResult = performSaturnProgression(nativeHoroscope, age)
      const result = `Age ${outputResult.age} Saturn Major progressed to sign ${outputResult.progressedHouse} <br>Planets ${outputResult.keyPlanets.toString()}`;

      const div = document.getElementById("results");
      div.insertAdjacentHTML('afterbegin', `<p><strong>${result}</strong></p>`);
    }

    function performSaturnProgression(horoscope, age) {
      const saturnSign = horoscope['Saturn']?.sign;
      if (!saturnSign || !age) return null;

      // Saturn takes 30 years to move 1 sign in it major , so we divide age by 30
      const houseFocus = Math.floor(age / 30) + 1;
      const houseFromSaturn = ((saturnSign - 1 + (houseFocus - 1)) % 12) + 1;

      const signLords = {
        1: 'Mars', 2: 'Venus', 3: 'Mercury', 4: 'Moon', 5: 'Sun', 6: 'Mercury',
        7: 'Venus', 8: 'Mars', 9: 'Jupiter', 10: 'Saturn', 11: 'Saturn', 12: 'Jupiter'
      };

      const planetsInHouse = Object.entries(horoscope)
        .filter(([_, val]) => val.sign === houseFromSaturn)
        .map(([p]) => p);

      const conjunctions = planetsInHouse.slice();

      const trineSigns = [1, 5, 9, 2, 6, 10, 3, 7, 11, 4, 8, 12];
      const trines = trineSigns.filter(s => (Math.abs(s - houseFromSaturn) % 4 === 0))
        .map(s => Object.entries(horoscope).filter(([_, val]) => val.sign === s).map(([p]) => p)).flat();

      const seventhHouse = ((houseFromSaturn + 6 - 1) % 12) + 1;
      const seventh = Object.entries(horoscope)
        .filter(([_, val]) => val.sign === seventhHouse)
        .map(([p]) => p);
      console.log('houseFocus:' + houseFocus + ' houseFromSaturn:' + houseFromSaturn + ' Dispositor Sign:' + (saturnSign + houseFromSaturn));
      var signOfSaturnProgression = (saturnSign - 1 + houseFocus) % 12;
      const saturnDispositor = signLords[signOfSaturnProgression];
      const dispositorsHouse = horoscope[saturnDispositor]?.sign;
      const conjunctionWithDispositor = Object.entries(horoscope)
        .filter(([p, val]) => val.sign === dispositorsHouse && p !== saturnDispositor)
        .map(([p]) => p);

      const seventhFromDispositor = ((dispositorsHouse + 6 - 1) % 12) + 1;
      const seventhFromDisp = Object.entries(horoscope)
        .filter(([_, val]) => val.sign === seventhFromDispositor)
        .map(([p]) => p);
      const resultSet = new Set([
        ...planetsInHouse,
        ...conjunctions,
        ...trines,
        ...seventh,
        ...conjunctionWithDispositor,
        ...seventhFromDisp,
        ...saturnDispositor
      ]);
      console.log(`saturnDispositor:` + saturnDispositor);
      console.log('planetsInHouse', planetsInHouse,
        '\nconjunctions', conjunctions,
        '\ntrines', trines,
        '\nseventh', seventh,
        '\nconjunctionWithDispositor', conjunctionWithDispositor,
        '\nseventhFromDisp', seventhFromDisp);
      return {
        age,
        focusHouse: houseFocus,
        progressedHouse: houseFromSaturn,
        keyPlanets: Array.from(resultSet)
      };
    }

    // Rahu's Major Progression
    function getRahuMajorProgression() {
      const rahuSign = parseInt(document.getElementById('Rahu-sign').value);
      const rahuHouse = parseInt(document.getElementById('Rahu-house').value);
      const age = parseInt(document.getElementById('age-select').value);
      var outputResult = performRahuProgression(nativeHoroscope, age)
      const result = `Age ${outputResult.age} Rahu Major progressed to sign ${outputResult.focusHouse} -> ${outputResult.progressedHouse} <br>Planets ${outputResult.keyPlanets.join(' , ')}`;

      const div = document.getElementById("results");
      div.insertAdjacentHTML('afterbegin', `<p><strong>${result}</strong></p>`);
    }

    function performRahuProgression(horoscope, age) {
      const rahuSign = horoscope['Rahu']?.sign;
      if (!rahuSign || !age) return null;

      // Rahu takes 18 years to move 1 sign/house BACKWARD in its major progression
      const houseFocus = Math.floor(age / 18) + 1;
      // Move backwards: subtract houseFocus - 1 from Rahu's sign/house, wrapping around 1-12
      const houseFromRahu = ((rahuSign - (houseFocus - 1) - 1 + 12) % 12) + 1;

      const signLords = {
        1: 'Mars', 2: 'Venus', 3: 'Mercury', 4: 'Moon', 5: 'Sun', 6: 'Mercury',
        7: 'Venus', 8: 'Mars', 9: 'Jupiter', 10: 'Saturn', 11: 'Saturn', 12: 'Jupiter'
      };

      const planetsInHouse = Object.entries(horoscope)
        .filter(([_, val]) => val.sign === houseFromRahu)
        .map(([p]) => p);

      const conjunctions = planetsInHouse.slice();

      const trineSigns = [1, 5, 9, 2, 6, 10, 3, 7, 11, 4, 8, 12];
      const trines = trineSigns.filter(s => (Math.abs(s - houseFromRahu) % 4 === 0))
        .map(s => Object.entries(horoscope).filter(([_, val]) => val.sign === s).map(([p]) => p)).flat();

      const seventhHouse = ((houseFromRahu + 6 - 1) % 12) + 1;
      const seventh = Object.entries(horoscope)
        .filter(([_, val]) => val.sign === seventhHouse)
        .map(([p]) => p);

      // Find the dispositor of Rahu's progressed sign
      const signOfRahuProgression = houseFromRahu;
      const rahuDispositor = signLords[signOfRahuProgression];
      const dispositorsHouse = horoscope[rahuDispositor]?.sign;
      const conjunctionWithDispositor = Object.entries(horoscope)
        .filter(([p, val]) => val.sign === dispositorsHouse && p !== rahuDispositor)
        .map(([p]) => p);

      const seventhFromDispositor = ((dispositorsHouse + 6 - 1) % 12) + 1;
      const seventhFromDisp = Object.entries(horoscope)
        .filter(([_, val]) => val.sign === seventhFromDispositor)
        .map(([p]) => p);

      const resultSet = new Set([
        ...planetsInHouse,
        ...conjunctions,
        ...trines,
        ...seventh,
        ...conjunctionWithDispositor,
        ...seventhFromDisp,
        ...rahuDispositor
      ]);
      console.log(`rahuDispositor:` + rahuDispositor);
      console.log('planetsInHouse', planetsInHouse,
        '\nconjunctions', conjunctions,
        '\ntrines', trines,
        '\nseventh', seventh,
        '\nconjunctionWithDispositor', conjunctionWithDispositor,
        '\nseventhFromDisp', seventhFromDisp);
      return {
        age,
        focusHouse: houseFocus,
        progressedHouse: houseFromRahu,
        keyPlanets: Array.from(resultSet)
      };
    }
    function getJupiterMajorProgression() {
      const jupiterSign = parseInt(document.getElementById('Jupiter-sign').value);
      const jupiterHouse = parseInt(document.getElementById('Jupiter-house').value);
      const age = parseInt(document.getElementById('age-select').value);
      var outputResult = performJupiterProgression(nativeHoroscope, age)
      const result = `Age ${outputResult.age} Jupiter Major progressed to sign ${outputResult.focusHouse} --> ${outputResult.progressedHouse} <br>Planets ${outputResult.keyPlanets.join(' , ')}`;

      const div = document.getElementById("results");
      div.insertAdjacentHTML('afterbegin', `<p><strong>${result}</strong></p>`);
    }
    function performJupiterProgression(horoscope, age) {
      const jupiterSign = horoscope['Jupiter']?.sign;
      if (!jupiterSign || !age) return null;

      const houseFocus = Math.floor(age / 12) + 1;
      const houseFromJupiter = ((jupiterSign - 1 + (houseFocus - 1)) % 12) + 1;

      const signLords = {
        1: 'Mars', 2: 'Venus', 3: 'Mercury', 4: 'Moon', 5: 'Sun', 6: 'Mercury',
        7: 'Venus', 8: 'Mars', 9: 'Jupiter', 10: 'Saturn', 11: 'Saturn', 12: 'Jupiter'
      };

      const planetsInHouse = Object.entries(horoscope)
        .filter(([_, val]) => val.sign === houseFromJupiter)
        .map(([p]) => p);

      const conjunctions = planetsInHouse.slice();

      const trineSigns = [1, 5, 9, 2, 6, 10, 3, 7, 11, 4, 8, 12];
      const trines = trineSigns.filter(s => (Math.abs(s - houseFromJupiter) % 4 === 0))
        .map(s => Object.entries(horoscope).filter(([_, val]) => val.sign === s).map(([p]) => p)).flat();

      const seventhHouse = ((houseFromJupiter + 6 - 1) % 12) + 1;
      const seventh = Object.entries(horoscope)
        .filter(([_, val]) => val.sign === seventhHouse)
        .map(([p]) => p);
      console.log('houseFocus:' + houseFocus + ' houseFromJupiter:' + houseFromJupiter + ' Dispositor Sign:' + (jupiterSign + houseFromJupiter));
      var signOfJupiterProgression = (jupiterSign - 1 + houseFocus) % 12;
      const jupiterDispositor = signLords[signOfJupiterProgression];
      const dispositorsHouse = horoscope[jupiterDispositor]?.sign;
      const conjunctionWithDispositor = Object.entries(horoscope)
        .filter(([p, val]) => val.sign === dispositorsHouse && p !== jupiterDispositor)
        .map(([p]) => p);

      const seventhFromDispositor = ((dispositorsHouse + 6 - 1) % 12) + 1;
      const seventhFromDisp = Object.entries(horoscope)
        .filter(([_, val]) => val.sign === seventhFromDispositor)
        .map(([p]) => p);

      const resultSet = new Set([
        ...planetsInHouse,
        ...conjunctions,
        ...trines,
        ...seventh,
        ...conjunctionWithDispositor,
        ...seventhFromDisp,
        ...jupiterDispositor
      ]);
      console.log(`jupiterDispositor:` + jupiterDispositor);
      console.log('planetsInHouse', planetsInHouse,
        '\nconjunctions', conjunctions,
        '\ntrines', trines,
        '\nseventh', seventh,
        '\nconjunctionWithDispositor', conjunctionWithDispositor,
        '\nseventhFromDisp', seventhFromDisp);
      return {
        age,
        focusHouse: houseFocus,
        progressedHouse: houseFromJupiter,
        keyPlanets: Array.from(resultSet)
      };
    }

    function analyzeTransits() {
      const jSign = parseInt(document.getElementById('transit-jupiter-sign').value);
      const sSign = parseInt(document.getElementById('transit-saturn-sign').value);

      const horoscope = {};
      planets.forEach(p => {
        const sign = parseInt(document.getElementById(`${p}-sign`).value);
        const degree = parseFloat(document.getElementById(`${p}-deg`).value);
        if (!isNaN(sign) && !isNaN(degree)) {
          horoscope[p] = { sign, degree };
        }
      });

      const transits = [];
      const planetInTransitAspects = { "Jupiter": [], "Saturn": [] };
      for (const [planet, { sign }] of Object.entries(horoscope)) {
        const aspects = [sign];

        if ((Math.abs(jSign - sign) % 12) === 6 || (Math.abs(jSign - sign) % 12) === 8 || (Math.abs(jSign - sign) % 12) === 2 || (Math.abs(jSign - sign) % 12) === 10)
          aspects.push(jSign);

        const jImpact = (sign === jSign) ? 'Strong (100%) - Same Sign' :
          ((Math.abs(jSign - sign) % 12) === 7) ? 'Very High (80%) - 7th Aspect' :
            ([1, 5, 9].includes(((sign - jSign + 12) % 12) + 1)) ? 'Moderate (50%) - Trine' :
              ([3, 11].includes(((sign - jSign + 12) % 12) + 1)) ? 'Mild (25%) -  3, 11 houses' : null;

        const sImpact = (sign === sSign) ? 'Strong (100%) - Same Sign' :
          ([3, 7, 10].includes(((sign - sSign + 12) % 12) + 1)) ? 'Very High (80%) 3rd,7th,10th Aspect' :
            ([1, 5, 9].includes(((sign - sSign + 12) % 12) + 1)) ? 'Moderate (50%) -  trinal rashis' :
              ([3, 11].includes(((sign - sSign + 12) % 12) + 1)) ? 'Mild (25%) -  3, 11 houses from transiting planets houses from transiting planets' : null;

        if (jImpact || sImpact) {
          const jText = jImpact ? `Jupiter → ${jImpact}` : '';
          const sText = sImpact ? `Saturn → ${sImpact}` : '';
          let detail = '';
          if (jImpact && jImpact.includes('Strong')) detail += 'Great opportunity for growth and dharma alignment. ';
          else if (jImpact && jImpact.includes('Very High')) detail += 'Influence on career, wisdom or expansion. ';
          else if (jImpact && jImpact.includes('Moderate')) detail += 'Spiritual or educational gains likely. ';
          if (sImpact && sImpact.includes('Strong')) detail += 'Strong karmic testing. Consolidation and discipline phase. ';
          else if (sImpact && sImpact.includes('Very High')) detail += 'Challenges to responsibility, long-term rewards. ';
          else if (sImpact && sImpact.includes('Moderate')) detail += 'Time to reflect and realign responsibilities. ';
          transits.push(`<strong>${planet}</strong>: ${jText}, ${sText}<br><em>${detail}</em>`);
          if (jImpact)
            planetInTransitAspects["Jupiter"].push(planet);
          else
            planetInTransitAspects["Saturn"].push(planet);
        }
      }
      var JupiterTransits = transit.TransitOutcomesBNN.JupiterTransits;
      var SaturnTransits = transit.TransitOutcomesBNN.SaturnTransits;
      const div = document.getElementById("results");
      const jOverPlanets = Object.entries(horoscope)
        .filter(([p, _]) => _.sign == jSign || planetInTransitAspects["Jupiter"].includes(p))
        .map(([p, v]) => {
          let msg = `Jupiter transiting over ${p} in Sign ${jSign}`;
          let effect = '';
          if (JupiterTransits && JupiterTransits[p]) {
            effect = JupiterTransits[p].map(e => `- ${e}`).join('<br>');
          } else {
            effect = 'General spiritual expansion.';
          }
          //}
          return `<li>${msg}<br><em>${effect}</em></li>`;
        }).join('');
      const sOverPlanets = Object.entries(horoscope)
        .filter(([p, _]) => _.sign == sSign || planetInTransitAspects["Saturn"].includes(p))
        .map(([p, v]) => {
          let msg = `Saturn transiting over ${p} in Sign ${sSign}`;
          let effect = '';
          if (SaturnTransits && SaturnTransits[p]) {
            effect = SaturnTransits[p].map(e => `- ${e}`).join('<br>');
          } else {
            effect = 'General karma maturation and slow progress.';
          }
          //}
          return `<li>${msg}<br><em>${effect}</em></li>`;
        }).join('');
      const html = `<h3>Transit Effects on Natal Planets</h3><ul>${transits.map(t => `<li>${t}</li>`).join('')}</ul><br><h4>Direct Transits:</h4><ul>${jOverPlanets}${sOverPlanets}</ul>`;
      div.insertAdjacentHTML('beforeend', html);
    }

    function getMarriageOutcomeForFemale(horoscope) {
      const venusSign = horoscope['Venus']?.sign;
      const marsSign = horoscope['Mars']?.sign;
      const jupiterSign = horoscope['Jupiter']?.sign;

      if (!venusSign || !marsSign || !jupiterSign) return 'Insufficient data to analyze marriage outcome.';

      const distance = (marsSign - venusSign + 12) % 12;
      let outcome = '';

      if ([1, 2, 3, 5, 7, 9, 11].includes(distance)) {
        outcome += '✅ Marriage is promised based on Mars-Venus positioning.<br>';
      } else if ([4, 6, 8, 10].includes(distance)) {
        outcome += '⚠️ Marriage obstacles indicated due to Mars in bad houses from Venus.<br>';
      }

      const getSignLord = sign => {
        const lords = {
          1: 'Mars', 2: 'Venus', 3: 'Mercury', 4: 'Moon', 5: 'Sun', 6: 'Mercury',
          7: 'Venus', 8: 'Mars', 9: 'Jupiter', 10: 'Saturn', 11: 'Saturn', 12: 'Jupiter'
        };
        return lords[sign];
      };

      const jupiterLord = getSignLord(jupiterSign);
      const jupiterLordSign = horoscope[jupiterLord]?.sign;
      const seventhFromJupiter = ((jupiterSign + 6 - 1) % 12) + 1;
      const seventhFromJLord = ((jupiterLordSign + 6 - 1) % 12) + 1;

      if ([1, 2, 3, 5, 7, 9, 11].includes((seventhFromJLord - jupiterLordSign + 12) % 12)) {
        outcome += '✅ Jupiters 7th lord is well placed — favorable for marriage.<br>';
      } else {
        outcome += '⚠️ Jupiters 7th lord is not ideally placed — possible delay or disruption.<br>';
      }

      if (((marsSign - jupiterSign + 12) % 12) === 4) {
        outcome += '✅ Jupiter aspects Mars — early marriage indicated.<br>';
      }

      // Detect possible outcomes for unmarried, separation, divorce
      const venusDegree = horoscope['Venus']?.degree || 0;
      const marsDegree = horoscope['Mars']?.degree || 0;
      const jupiterDegree = horoscope['Jupiter']?.degree || 0;

      if (((venusSign === marsSign) && Math.abs(venusDegree - marsDegree) <= 1) &&
        ((venusSign === jupiterSign) && Math.abs(venusDegree - jupiterDegree) <= 1)) {
        outcome += '⚠️ Strong Venus conjunctions with Mars and Jupiter — high chance of separation/divorce.<br>';
      }

      if (marsSign === jupiterSign && Math.abs(marsDegree - jupiterDegree) < 2) {
        outcome += '⚠️ Jupiter-Mars conjunction in same sign — may indicate emotional burnout or detachment, possible divorce.<br>';
      }

      const malefics = ['Saturn', 'Rahu', 'Ketu'];
      const maleficInfluence = malefics.filter(m => horoscope[m]?.sign === venusSign).length;

      if (maleficInfluence >= 2) {
        outcome += '⚠️ Venus heavily afflicted by malefics — high chance of remaining unmarried or relationship instability.<br>';
      }

      // Additional BNN-based conditions
      const ketuSign = horoscope['Ketu']?.sign;
      const rahuSign = horoscope['Rahu']?.sign;
      const saturnSign = horoscope['Saturn']?.sign;

      // Venus in 4/6/8/10 from Jupiter
      const venusFromJupiter = (venusSign - jupiterSign + 12) % 12;
      if ([3, 5, 7, 9].includes(venusFromJupiter)) {
        outcome += '⚠️ Venus in 4/6/8/10 from Jupiter — delays or disruption in marriage.<br>';
      }

      // Ketu in 1/5/9/2 from Venus
      const ketuFromVenus = (ketuSign - venusSign + 12) % 12;
      if ([0, 4, 8, 1].includes(ketuFromVenus)) {
        outcome += '⚠️ Ketu in 1st/5th/9th/2nd from Venus — spiritual detachment or denial in relationships.<br>';
      }

      // 7th lord from Jupiter in 4/6/8/10 from Jupiters lord
      const jupiter7thLord = getSignLord(seventhFromJupiter);
      const jupiter7thLordSign = horoscope[jupiter7thLord]?.sign;
      const posFromJLord = (jupiter7thLordSign - jupiterLordSign + 12) % 12;
      if ([3, 5, 7, 9].includes(posFromJLord)) {
        outcome += '⚠️ Jupiters 7th lord ' + jupiter7thLord + ' in 4/6/8/10 from Jupiters lord ' + jupiterLord + ' — obstruction in marital harmony.<br>';
      }

      // Ketu in 1/5/9/2 from Jupiters 7th lord
      const ketuFromJup7th = (ketuSign - jupiter7thLordSign + 12) % 12;
      if ([0, 4, 8, 1].includes(ketuFromJup7th)) {
        outcome += '⚠️ Ketu afflicting Jupiters 7th lord — difficulty in commitment or detachment from spouse.<br>';
      }

      // Sequence: Jupiter + Ketu + Venus or Venus + Ketu + Jupiter
      const seq = [jupiterSign, ketuSign, venusSign];
      const seqAlt = [venusSign, ketuSign, jupiterSign];
      const ordered = (a, b, c) => ((a + 1) % 12 === b % 12 && (b + 1) % 12 === c % 12);
      if (ordered(...seq) || ordered(...seqAlt)) {
        outcome += '⚠️ Jupiter, Ketu, and Venus in successive signs — high chance of divorce or no progeny.<br>';
      }

      // Sequence: Jupiters lord + Ketu + Jupiters 7th lord or reverse
      const seq2 = [jupiterLordSign, ketuSign, jupiter7thLordSign];
      const seq2Alt = [jupiter7thLordSign, ketuSign, jupiterLordSign];
      if (ordered(...seq2) || ordered(...seq2Alt)) {
        outcome += '⚠️ Jupiters lord, Ketu, and 7th lord in sequence — breakup or denial of marriage/progeny.<br>';
      }

      // Venus hemmed between Rahu and Ketu
      if ((rahuSign < venusSign && venusSign < ketuSign) || (ketuSign < venusSign && venusSign < rahuSign)) {
        outcome += '⚠️ Venus hemmed between Rahu and Ketu — marriage not promised unless Jupiter aspects Venus.<br>';
      }

      // Saturn aspects Venus (7th from Saturn)
      const saturnAspects = ((saturnSign + 6) % 12) + 1;
      if (saturnAspects === venusSign) {
        outcome += '⚠️ Saturn aspects Venus — marriage may be delayed significantly.<br>';
      }

      // --- Spouse Health / Widowhood Checks ---
      // Mars for female, check 1/2/5/9 from Rahu
      const marsFromRahu = (marsSign - rahuSign + 12) % 12;
      if ([0, 1, 4, 8].includes(marsFromRahu)) {
        outcome += '⚠️ Mars (females spouse indicator) is in 1st/2nd/5th/9th from Rahu — possible threat to spouses health or early death.<br>';
      }

      // Mars hemmed between Rahu and Saturn (direction-wise)
      if ((rahuSign < marsSign && marsSign < saturnSign) || (saturnSign < marsSign && marsSign < rahuSign)) {
        outcome += '⚠️ Mars hemmed between Rahu and Saturn — can indicate widowhood or loss of spouse. As the combination denotes accidents or accidental death or major health problems like heart at ache or cancer or unnatural death to her husband<br>';
      }

      const div = document.getElementById("results");
      div.insertAdjacentHTML('afterbegin', `<p>Female Marriage :<br><strong>${outcome}</strong></p>`);
      return outcome || '⚠️ No strong marriage indicators found based on Mars and Jupiter analysis.';

    }

    function getMarriageOutcomeForMale(horoscope) {
      const venusSign = horoscope['Venus']?.sign;
      const jupiterSign = horoscope['Jupiter']?.sign;
      const marsSign = horoscope['Mars']?.sign;

      if (!venusSign || !jupiterSign || !marsSign) return 'Insufficient data to analyze marriage outcome.';

      let outcome = '';

      const getSignLord = sign => {
        const lords = {
          1: 'Mars', 2: 'Venus', 3: 'Mercury', 4: 'Moon', 5: 'Sun', 6: 'Mercury',
          7: 'Venus', 8: 'Mars', 9: 'Jupiter', 10: 'Saturn', 11: 'Saturn', 12: 'Jupiter'
        };
        return lords[sign];
      };

      const distance = (venusSign - jupiterSign + 12) % 12;
      if ([1, 2, 3, 5, 7, 9, 11].includes(distance)) {
        outcome += '✅ Marriage is promised based on Venus-Jupiter positioning.<br>';
      } else if ([4, 6, 8, 10].includes(distance)) {
        outcome += '⚠️ Marriage obstacles indicated due to Venus in bad houses from Jupiter.<br>';
      }

      const venusDegree = horoscope['Venus']?.degree || 0;
      const jupiterDegree = horoscope['Jupiter']?.degree || 0;
      const marsDegree = horoscope['Mars']?.degree || 0;
      const ketuSign = horoscope['Ketu']?.sign;
      const rahuSign = horoscope['Rahu']?.sign;
      const saturnSign = horoscope['Saturn']?.sign;

      const jupiterLord = getSignLord(jupiterSign);
      const jupiterLordSign = horoscope[jupiterLord]?.sign;
      const seventhFromJupiter = ((jupiterSign + 6 - 1) % 12) + 1;
      const seventhFromJLord = ((jupiterLordSign + 6 - 1) % 12) + 1;

      const jupiter7thLord = getSignLord(seventhFromJupiter);
      const jupiter7thLordSign = horoscope[jupiter7thLord]?.sign;

      // Jupiters 7th lord placement
      const posFromJLord = (jupiter7thLordSign - jupiterLordSign + 12) % 12;
      if ([1, 2, 3, 5, 7, 9, 11].includes(posFromJLord)) {
        outcome += '✅ Jupiters 7th lord is well placed — favorable for marriage.<br>';
      } else {
        outcome += '⚠️ Jupiters 7th lord is not ideally placed — possible delay or disruption.<br>';
      }

      // Venus-Mars conjunction tight
      if ((venusSign === marsSign) && Math.abs(venusDegree - marsDegree) <= 1) {
        outcome += '⚠️ Venus conjunct Mars — possible friction, passionate but unstable marriage.<br>';
      }

      // Venus heavily afflicted by malefics
      const malefics = ['Saturn', 'Rahu', 'Ketu'];
      const maleficInfluence = malefics.filter(m => horoscope[m]?.sign === venusSign).length;
      if (maleficInfluence >= 2) {
        outcome += '⚠️ Venus heavily afflicted — risk of separation or not getting married.<br>';
      }

      // Venus in 4/6/8/10 from Jupiter
      const venusFromJupiter = (venusSign - jupiterSign + 12) % 12;
      if ([3, 5, 7, 9].includes(venusFromJupiter)) {
        outcome += '⚠️ Venus in 4/6/8/10 from Jupiter — delays or disruption in marriage.<br>';
      }

      // Ketu in 1/5/9/2 from Venus
      const ketuFromVenus = (ketuSign - venusSign + 12) % 12;
      if ([0, 4, 8, 1].includes(ketuFromVenus)) {
        outcome += '⚠️ Ketu in 1st/5th/9th/2nd from Venus — detachment or loss in relationship matters.<br>';
      }

      // Jupiters 7th lord in 4/6/8/10 from Jupiters lord
      if ([3, 5, 7, 9].includes(posFromJLord)) {
        outcome += '⚠️ Jupiters 7th lord ' + jupiter7thLord + ' in 4/6/8/10 from its lord ' + jupiterLord + ' — challenge to long-term marriage.<br>';
      }

      // Ketu in 1/5/9/2 from Jupiters 7th lord
      const ketuFromJup7th = (ketuSign - jupiter7thLordSign + 12) % 12;
      if ([0, 4, 8, 1].includes(ketuFromJup7th)) {
        outcome += '⚠️ Ketu afflicting Jupiters 7th lord — instability or emotional detachment.<br>';
      }

      // Sequences Venus + Ketu + Jupiter or reverse
      const seq = [venusSign, ketuSign, jupiterSign];
      const seqAlt = [jupiterSign, ketuSign, venusSign];
      const ordered = (a, b, c) => ((a + 1) % 12 === b % 12 && (b + 1) % 12 === c % 12);
      if (ordered(...seq) || ordered(...seqAlt)) {
        outcome += '⚠️ Venus, Ketu, and Jupiter in successive signs — risk of no marriage or divorce.<br>';
      }

      // Jupiters lord + Ketu + 7th lord or reverse
      const seq2 = [jupiterLordSign, ketuSign, jupiter7thLordSign];
      const seq2Alt = [jupiter7thLordSign, ketuSign, jupiterLordSign];
      if (ordered(...seq2) || ordered(...seq2Alt)) {
        outcome += '⚠️ Jupiters lord, Ketu and 7th lord in sequence — major relationship challenges.<br>';
      }

      // Venus hemmed between Rahu and Mars/Saturn (direction-wise)
      const venusHemmed = (
        (rahuSign < venusSign && venusSign < marsSign) || (marsSign < venusSign && venusSign < rahuSign) ||
        (rahuSign < venusSign && venusSign < saturnSign) || (saturnSign < venusSign && venusSign < rahuSign) ||
        (marsSign < venusSign && venusSign < saturnSign) || (saturnSign < venusSign && venusSign < marsSign)
      );
      if (venusHemmed) {
        outcome += '⚠️ Venus hemmed between malefics —  the combination denotes accidents or accidental and Saturn(Direction Wise), the combination denotes accidents or accidental death or major health problems like heart at ache or cancer or unnatural death death or major health problems like heart at ache or cancer or unnatural death to wife.<br>';
      }

      // Venus hemmed between Rahu and Mars/Saturn (direction-wise)
      const venusHemmedMalefic = (
        (rahuSign < venusSign && venusSign < ketuSign) || (ketuSign < venusSign && venusSign < rahuSign)
      );
      const jupiterAspectOnVenus = [4, 6, 8].includes((venusSign - jupiterSign + 12) % 12);

      if (venusHemmedMalefic) {
        if (jupiterAspectOnVenus) {
          outcome += '⚠️ Venus hemmed between Rahu and Ketu — but Jupiters aspect nullifies this dosha, early marriage possible.<br>';
        } else {
          outcome += '❌ Venus hemmed between Rahu and Ketu — marriage not promised unless Jupiter aspects Venus.<br>';
        }
      }

      // Venus in 1st/2nd/5th/9th from Rahu (threat to spouse)
      const venusFromRahu = (venusSign - rahuSign + 12) % 12;
      if ([0, 1, 4, 8].includes(venusFromRahu)) {
        outcome += '⚠️ Venus in 1/2/5/9 from Rahu — risk to spouse health or longevity.<br>';
      }

      // Venus hemmed between Rahu and Mars, or Rahu and Saturn, or Mars and Saturn (direction-wise)
      const venusHemmedAccident = (
        (rahuSign < venusSign && venusSign < marsSign) || (marsSign < venusSign && venusSign < rahuSign) ||
        (rahuSign < venusSign && venusSign < saturnSign) || (saturnSign < venusSign && venusSign < rahuSign) ||
        (marsSign < venusSign && venusSign < saturnSign) || (saturnSign < venusSign && venusSign < marsSign)
      );
      if (venusHemmedAccident) {
        outcome += '❗ Venus hemmed between malefics (Rahu, Mars, Saturn) — potential for accidents, major illness, or unnatural death of spouse.<br>';
      }

      // Jupiter aspects Venus (5th, 7th, 9th aspects)
      const diffJV = (venusSign - jupiterSign + 12) % 12;
      if ([4, 6, 8].includes(diffJV)) {
        outcome += '✅ Jupiter aspects Venus — early or blessed marriage indicated.<br>';
      }

      // Saturn aspects Venus (3rd, 7th, 10th aspects)
      const diffSV = (venusSign - saturnSign + 12) % 12;
      if ([2, 6, 9].includes(diffSV)) {
        outcome += '⚠️ Saturn aspects Venus — marriage likely delayed and requires patience.<br>';
      }
      const div = document.getElementById("results");
      div.insertAdjacentHTML('afterbegin', `<p>Male Marriage :<br><strong>${outcome}</strong></p>`);

      return outcome || '⚠️ No strong marriage indicators found based on Venus and Jupiter analysis.';
    }

    // Save horoscope to local storage with a name
    function saveHoroscopeWithName(name, horoscope) {
      const all = JSON.parse(localStorage.getItem('bnnHoroscopes') || '{}');
      all[name] = horoscope;
      localStorage.setItem('bnnHoroscopes', JSON.stringify(all));
      updateHoroscopeDropdown();
    }

    // Load horoscope from local storage by name
    function loadHoroscopeByName(name) {
      const all = JSON.parse(localStorage.getItem('bnnHoroscopes') || '{}');
      const horoscope = all[name];
      if (horoscope) {
        Object.entries(horoscope).forEach(([planet, data, house]) => {
          const signEl = document.getElementById(`${planet}-sign`);
          const degEl = document.getElementById(`${planet}-deg`);
          const houseE1 = document.getElementById(`${planet}-house`);
          const retrogradeEl = document.getElementById(`${planet}-retrograde`);
          if (retrogradeEl) {
            retrogradeEl.checked = data.retrograde || false;
          }
          if (signEl && degEl) {
            signEl.value = data.sign;
            degEl.value = data.degree;
            houseE1.value = data.house;
          }
        });
        document.getElementById('horoscope-name').value = name;
      }
    }

    // Update the dropdown options with saved horoscopes
    function updateHoroscopeDropdown() {
      const all = JSON.parse(localStorage.getItem('bnnHoroscopes') || '{}');
      const dropdown = document.getElementById('horoscope-select');
      dropdown.innerHTML = '<option value="">-- Select Saved Horoscope --</option>';
      Object.keys(all).forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        dropdown.appendChild(opt);
      });
    }

    // Interpret a conjunction using living/non-living and sign traits
    function interpretConjunction(planets, sign, data) {
      const planetData = data.planets;
      const signData = data.zodiac_signs.find(z => z.sign === sign);

      const livingTraits = [];
      const nonLivingTraits = [];

      planets.forEach((p, idx) => {
        const pData = planetData.find(x => x.name === p);
        if (!pData || !pData.characteristics?.significators?.length) return;
        const sigs = pData.characteristics.significators;
        if (idx === 0) {
          livingTraits.push(...sigs.filter(s => !s.toLowerCase().includes("karma")));
        } else {
          nonLivingTraits.push(...sigs.filter(s => s.length < 30));
        }
      });

      const signTraits = signData?.characteristics || [];
      //signData?.characteristics?.slice(0, 3) || [];
      const subject = livingTraits[0] || 'Someone';
      const effect = nonLivingTraits[0] || 'some outcome';
      const field = signTraits[0] || 'some area';

      let combinations = [];
      livingTraits.forEach(subject => {
        nonLivingTraits.forEach(effect => {
          signTraits.forEach(field => {
            combinations.push(`${subject} experiences ${effect} in ${field} (Sign: ${sign})`);
          });
        });
      });
      return combinations.length ? combinations : [`${subject} experiences ${effect} in ${field} (Sign: ${sign})`];
    }

    // Batch interpret all conjunctions and display
    function interpretAllConjunctions(horoscope, data) {
      const results = {};
      const signMap = {};

      Object.entries(horoscope).forEach(([planet, { sign }]) => {
        if (!signMap[sign]) signMap[sign] = [];
        signMap[sign].push(planet);
      });

      Object.entries(signMap).forEach(([sign, planets]) => {
        if (planets.length > 1) {
          for (let i = 0; i < planets.length; i++) {
            for (let j = i + 1; j < planets.length; j++) {
              const pairKey = `${planets[i]} & ${planets[j]} in ${sign}`;
              results[pairKey] = interpretConjunction([planets[i], planets[j]], signs[sign - 1], data);
            }
          }
        }
      });

      const container = document.createElement('div');
      container.style.display = 'flex';
      container.style.flexWrap = 'wrap';
      container.style.gap = '16px';
      container.style.marginTop = '20px';

      Object.entries(results).forEach(([key, msgs]) => {
        const card = document.createElement('div');
        card.style.border = '1px solid #ccc';
        card.style.padding = '12px';
        card.style.borderRadius = '8px';
        card.style.background = '#f9f9f9';
        //card.style.width = '300px';

        const title = document.createElement('h4');
        title.textContent = key;
        card.appendChild(title);

        const list = document.createElement('ul');
        msgs.forEach(msg => {
          const li = document.createElement('li');
          li.textContent = msg;
          list.appendChild(li);
        });
        card.appendChild(list);
        container.appendChild(card);
      });

      const outputTarget = document.createElement('div');
      outputTarget.id = 'interpretationCont';
      outputTarget.scrollIntoView({ behavior: 'smooth' });
      //outputTarget.innerHTML = '';
      outputTarget.appendChild(container);
      const toggleContainer = document.createElement('div');
      toggleContainer.style.marginTop = '10px';
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = 'toggle-output';
      checkbox.checked = 'true';
      // checkbox.addEventListener('change', () => {
      //   outputTarget.style.display = checkbox.checked ? 'block' : 'none';
      //   console.log('Visibility', outputTarget.style.display);
      // });
      const label = document.createElement('label');
      label.htmlFor = 'toggle-output';
      label.textContent = ' Show Interpretations';
      toggleContainer.appendChild(checkbox);
      toggleContainer.appendChild(label);
      toggleContainer.appendChild(outputTarget);
      const div = document.getElementById("results");
      div.insertAdjacentHTML('afterbegin', toggleContainer.innerHTML);
      console.log('interpretAllConjunctions', results);

      // document.getElementById('toggle-output').addEventListener('change', () => {
      //   document.getElementById('interpretationCont').style.display = this.checked ? 'block' : 'none';
      //   console.log('Visibility', this.checked, document.getElementById('interpretationCont').style.display);
      // });

      // document.addEventListener('DOMContentLoaded', () => {

      const toggleConjunctionsCheckbox = document.getElementById('toggle-output');
      const conjunctionsContainer = document.getElementById('interpretationCont');

      // Function to toggle visibility
      const toggleVisibility = (checkbox, container) => {
        if (checkbox.checked) {
          container.style.display = 'block'; // or 'flex', 'grid', etc. based on your layout
        } else {
          container.style.display = 'none';
        }
      };

      // Add event listeners
      if (toggleConjunctionsCheckbox && conjunctionsContainer) {
        toggleConjunctionsCheckbox.addEventListener('change', () => {
          toggleVisibility(toggleConjunctionsCheckbox, conjunctionsContainer);
        });
        // Initial state
        toggleVisibility(toggleConjunctionsCheckbox, conjunctionsContainer);
      }
      // });


      return Object.keys(results);
    }

    // Interpret house lord placements and display results
    function fetchLordData(nthLord, inHouse) {
      // Load the JSON data (replace this with the actual JSON object or fetch it dynamically)
      const jsonData = houseLordData;

      // Check if the nth Lord exists in the JSON data
      if (jsonData[nthLord]) {
        // Check if the inHouse exists for the nth Lord
        if (jsonData[nthLord][inHouse]) {
          return jsonData[nthLord][inHouse];
        } else {
          return `House ${inHouse} not found for ${nthLord}.`;
        }
      } else {
        return `${nthLord} not found in the data.`;
      }
    }

    //const result = fetchLordData("8th Lord", "1");
    //console.log(result);
    function generateHTMLTable(jsonData, column1hdr, column2hdr) {
      // Helper function to create a table row
      function createRow(key, value) {
        return `<tr>
                    <td style="border: 1px solid #ccc; padding: 8px; font-weight: bold;">${key}</td>
                    <td style="border: 1px solid #ccc; padding: 8px;">${value}</td>
                </tr>`;
      }

      // Recursive function to process JSON data
      function processJSON(data) {
        let html = "";
        for (const key in data) {
          if (typeof data[key] === "object" && data[key] !== null) {
            // If the value is an object, recursively process it
            html += `<tr>
                            <td colspan="2" style="border: 1px solid #ccc; padding: 8px; background-color: #f9f9f9; font-weight: bold;">${key}</td>
                         </tr>`;
            html += processJSON(data[key]);
          } else {
            // If the value is a primitive, add it to the table
            html += createRow(key, data[key]);
          }
        }
        return html;
      }

      // Generate the table structure
      const tableHTML = `
        <table style="border-collapse: collapse; width: 100%; font-family: Arial, sans-serif;">
            <thead>
                <tr>
                    <th style="border: 1px solid #ccc; padding: 8px; background-color: #f2f2f2;">${column1hdr}</th>
                    <th style="border: 1px solid #ccc; padding: 8px; background-color: #f2f2f2;">${column2hdr}</th>
                </tr>
            </thead>
            <tbody>
                ${processJSON(jsonData)}
            </tbody>
        </table>
    `;

      return tableHTML;
    }

    // Example usage

    // Example usage:
    // const output = interpretAllConjunctions(horoscope, property);
    // output.forEach(msg => console.log(msg));

    // Find placement of sign lords in houses
    function getSignLordPlacements(horoscope) {
      // const signLords = {
      //   1: 'Mars', 2: 'Venus', 3: 'Mercury', 4: 'Moon', 5: 'Sun', 6: 'Mercury',
      //   7: 'Venus', 8: 'Mars', 9: 'Jupiter', 10: 'Saturn', 11: 'Saturn', 12: 'Jupiter'
      // };
      const signLords = {
        1: ['Mars'],
        2: ['Venus'],
        3: ['Mercury'],
        4: ['Moon'],
        5: ['Sun'],
        6: ['Mercury'],
        7: ['Venus'],
        8: ['Mars', 'Ketu'],
        9: ['Jupiter'],
        10: ['Saturn'],
        11: ['Saturn', 'Rahu'],
        12: ['Jupiter']
      };
      var tableHTML = '';
      const placements = {};
      for (let sign = 1; sign <= 12; sign++) {

        signLords[sign].forEach(lord => {
          if (!horoscope[lord]) {
            placements[`Sign ${sign}`] = `${lord} not found in chart`;
            return;
          }
          //const lord = signLords[sign];
          const planetData = horoscope[lord];
          if (planetData && planetData.house) {
            var houseOfSign = getHouseOfSign(sign, horoscope);
            placements[`Sign ${sign}`] = `${lord}:  ${houseOfSign} house lord is placed in House ${planetData.house}`;
          } else {
            placements[`Sign ${sign}`] = `${lord} not found or house not defined in chart`;
          }
          const jsonData = fetchLordData(houseOfSign + "Lord", planetData.house + ""); // Replace with your fetchLordData function
          tableHTML += generateHTMLTable(jsonData, lord + "( " + houseOfSign + "Lord )", "In " + planetData.house + " House");
          // Append the table to the body of the HTML document
        });

      }
      createCard('House Lord Placements', tableHTML, 'html');
      return placements;
    }

    const getHouseOfSign = (sign, horoscope) => {
      var entry = Object.values(horoscope).find(p => p.sign === sign);
      // if no entry found, search the house in which a sign is placed in the cyclicHoroscope object
      if (!entry) {
        Object.entries(createCyclicJSON(horoscope)).forEach(([currhouse, data]) => {
          if (data.sign === sign) {
            entry = { house: currhouse };
          }
        });
      }
      return entry?.house || null;
    };
    // Add button to show sign lord placements
    function showSignLordPlacements(horoscope) {
      const placements = getSignLordPlacements(horoscope);

      let placementContainer = document.getElementById('lord-placement-results');
      if (!placementContainer) {
        placementContainer = document.createElement('div');
        placementContainer.id = 'lord-placement-results';
        placementContainer.style.marginTop = '20px';
        document.body.appendChild(placementContainer);
      }
      placementContainer.innerHTML = '';
      const list = document.createElement('ul');
      Object.entries(placements).forEach(([sign, msg]) => {
        const li = document.createElement('li');
        li.textContent = msg;
        list.appendChild(li);
      });
      placementContainer.appendChild(list);
      const div = document.getElementById("results");
      div.insertAdjacentHTML('afterbegin', `${placementContainer.innerHTML}`);

    }

    // Determine profession from horoscope
    function getProfessionFromHoroscope(horoscope) {
      const saturn = horoscope['Saturn'];
      if (!saturn) return 'Saturn not found in chart';

      const rashiProfessions = {
        1: 'Govt. job, Police, Military Service, Engineering, Agriculture, Construction',
        2: 'Fine Arts, Banking, Finance, Insurance, Share Market, Jewelry',
        3: 'Journalism, Media, Marketing, Teaching, Tutoring',
        4: 'Food, Travel, Marine, Economics, Navy, Hospitality',
        5: 'CEO, Manager, Govt. Authority, Team Lead, HR',
        6: 'Law, Astrology, Consulting, Agriculture, Village Admin',
        7: 'Medicine, Law, Banking, Finance, Arts',
        8: 'Engineering, Surgery, Machinery, Research, Coding',
        9: 'Teaching, Consulting, Banking, Management',
        10: 'CA, Professor, IAS, UPSC, Neurosurgeon',
        11: 'Psychologist, Consultant, Telecom, Navy, CBI',
        12: 'Aviation, Auto, International Travel, Foreign Work'
      };

      const prof = rashiProfessions[saturn.sign];
      let extras = [];

      // Get aspects: 3rd, 7th, 10th, and trine (1, 5, 9) signs from Saturn
      const aspectSigns = [
        (saturn.sign + 2) % 12 || 12,
        (saturn.sign + 6) % 12 || 12,
        (saturn.sign + 9) % 12 || 12,
        saturn.sign,
        (saturn.sign + 4) % 12 || 12,
        (saturn.sign + 8) % 12 || 12
      ];

      // If retrograde, calculate trine signs from the sign preceding Saturn's sign
      if (saturn.retrograde) {
        const previousSign = (saturn.sign - 1 + 12) % 12 || 12;
        aspectSigns.push(
          previousSign,
          (previousSign + 4) % 12 || 12,
          (previousSign + 8) % 12 || 12
        );
      }

      const influenceDetails = Object.entries(horoscope)
        .filter(([p, d]) => p !== 'Saturn' && aspectSigns.includes(d.sign))
        .map(([p, d]) => {
          const diff = (d.sign - saturn.sign + 12) % 12;
          let aspectType = '';
          if (d.sign === saturn.sign) aspectType = 'Conjunction';
          else if (diff === 2) aspectType = '3rd aspect';
          else if (diff === 6) aspectType = '7th aspect';
          else if (diff === 9) aspectType = '10th aspect';
          else if (diff === 4 || diff === 8) aspectType = 'Trine';
          else if (saturn.retrograde && [
            (saturn.sign - 1 + 12) % 12 || 12,
            (saturn.sign - 1 + 4 + 12) % 12 || 12,
            (saturn.sign - 1 + 8 + 12) % 12 || 12
          ].includes(d.sign)) aspectType = 'Retrograde Trine';
          return `${p} (${aspectType})`;
        });

      const planetHints = {
        Sun: 'Name , Fame,Recognition in profession, High paid Job, Higher rank, Authority, Would be unsatisfied with low esteem job, Govt. Job, Politics, MBA, Hospital, Establishing Planet.',
        Moon: 'Food Business, Grocery Store, Mo+Ra(Kirana store, Wholesale store), Tours and travel company, transferrable Govt./Private job, Navy, chemistry, economics, Liquor, Coldrinks, water related, Changes , up-down , travels in profession.',
        Mars: 'Engineering, Technical skills, ITI, Army, Defense Forces, Police, Surgeon, Dentist, Construction Work, Real Estate, B.com, Accountant, Electronics, Vastu',
        Mercury: 'Business, Education, Journalism, Mathematics',
        Venus: ' Money, Assets, Vehicles , Bank, Finances, Insurance, Trading, Fine Arts, Garments, Utensils, Home Décor, Designing, smoothness in profession.',
        Jupiter: 'Helps in Law education, Teacher, B.Ed. , Well educated, can always study, social work, CA, consultant, bank',
        Rahu: 'Software Engineer, MNC, Shadow and unethical work(Betting etc.), Profession in foreign land, digital marketing, export import, person is extremely intelligent',
        Ketu: 'Coding, Yoga teacher, spiritual guru, astrologer, occult, vastu , Surgery , Law, Low skilled jobs(Tailor, barber, painter etc.) Native is not happy with Job and wants to do something of his own.'
      };

      influenceDetails.forEach(detail => {
        const name = detail.split(' ')[0];
        if (planetHints[name]) extras.push(planetHints[name]);
      });

      const aspectsText = influenceDetails.length ? `

      Aspecting planets: ${influenceDetails.join('<br> ')}` : '';

      createCard('Career Insights from Saturn', `Saturn in sign ${saturn.sign}: ${prof}.<br>
      <strong>Additional indicators:</strong> ${extras.join(' <br> ') || 'None'}${aspectsText}`, 'html');
      return `Saturn in sign ${saturn.sign}: ${prof}.

      Additional indicators: ${extras.join(' , ') || 'None'}${aspectsText}`;
    }

    //Function creates a reusable card
    function createCard(title, content, type) {
      const card = document.createElement('div');
      card.style.border = '2px solid #0066cc';
      card.style.padding = '12px';
      card.style.borderRadius = '8px';
      card.style.background = '#e6f0ff';
      card.style.marginTop = '20px';
      card.style.width = '100%';
      card.id = title.toLowerCase().replace(/\s+/g, '-') + '-card';
      card.style.width = '100%';
      card.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
      card.style.transition = 'transform 0.2s';
      card.addEventListener('mouseover', () => {
        card.style.transform = 'scale(1.02)';
      });
      card.addEventListener('mouseout', () => {
        card.style.transform = 'scale(1)';
      });
      card.style.cursor = 'pointer';
      card.style.textAlign = 'left';
      card.style.fontFamily = 'Arial, sans-serif';
      const cardTitle = document.createElement('h3');
      cardTitle.textContent = title;
      card.appendChild(cardTitle);

      const cardContent = document.createElement('p');
      if (type === 'html') {
        cardContent.innerHTML = content;
      } else {
        cardContent.style.whiteSpace = 'pre-line';
        cardContent.style.lineHeight = '1.5';
        cardContent.style.fontSize = '14px';
        cardContent.style.color = '#333';
        cardContent.style.marginTop = '10px';
        cardContent.textContent = content.toString().replace(/,/g, '\n');
      }
      card.appendChild(cardContent);
      document.getElementById('results')?.prepend(card);
      return card;
    }

    // Show career insights from Saturn
    function showProfessionFromHoroscope(horoscope) {
      const professionText = getProfessionFromHoroscope(horoscope);
      let card = document.getElementById('profession-card');
      if (!card) {
        card = document.createElement('div');
        card.id = 'profession-card';
        card.style.border = '2px solid #0066cc';
        card.style.padding = '12px';
        card.style.borderRadius = '8px';
        card.style.background = '#e6f0ff';
        card.style.marginTop = '20px';
        card.style.width = '100%';
        document.getElementById('results')?.prepend(card);
      } else {
        card.innerHTML = '';
      }
      const title = document.createElement('h3');
      title.textContent = 'Career Insights based on Saturn';
      const para = document.createElement('p');
      para.textContent = professionText;
      card.appendChild(title);
      card.appendChild(para);
    }

    function getWorkEnvironmentFromHoroscope(horoscope) {
      const saturn = horoscope['Saturn'];
      if (!saturn || !saturn.sign) return 'Saturn sign not found.';

      const twelfthSign = (saturn.sign + 11) % 12 || 12;
      const twelfthHousePlanets = Object.entries(horoscope)
        .filter(([p, d]) => d.sign === twelfthSign)
        .map(([p]) => p);

      const goodPlanets = ['Venus', 'Jupiter', 'Sun', 'Mercury'];
      const badPlanets = ['Mars', 'Rahu', 'Ketu'];

      const good = twelfthHousePlanets.filter(p => goodPlanets.includes(p));
      const bad = twelfthHousePlanets.filter(p => badPlanets.includes(p));

      let result = `12th from Saturn is Sign ${twelfthSign}.`;
      if (twelfthHousePlanets.length === 0) {
        result += `\nNo planets in the 12th from Saturn — neutral work environment.`;
      } else {
        result += `\nPlanets in 12th from Saturn: ${twelfthHousePlanets.join(', ')}`;
        if (bad.length) {
          result += `\n⚠️ Not good work environment due to: ${bad.join(', ')}`;
        }
        if (good.length) {
          result += `\n✅ Enjoyable work environment due to: ${good.join(', ')}`;
        }
      }

      if (twelfthHousePlanets.length && saturn.retrograde) {
        result += `\n🌀 Since Saturn is retrograde, profession may be out of compulsion or external pressure.`;
      }
      // const div = document.getElementById("results");
      // div.insertAdjacentHTML('afterbegin', `${result}`);
      createCard('Work Environment from Saturn', result, 'text');
      return result;
    }


    /**
 * A helper function that invokes getAstrologyPredictions and formats the output.
 * It takes a horoscope object, generates predictions, and returns a formatted string.
 *
 * @param {object} horoscope - The horoscope data object.
 * @param {function} predictionFunc - The prediction function to invoke (e.g., getAstrologyPredictions).
 * @returns {string} A formatted string containing the astrological predictions.
 */
    function displayChildHealthPredictions(horoscope, predictionFunc) {
      // 1. Invoke the main prediction function to get the prediction data.
      const predictions = predictionFunc(horoscope);

      // 2. Format the output into a readable string.
      let output = "--- Astrological Predictions ---\n\n";

      // Format Childbirth Predictions
      output += "CHILDREN & CHILDBIRTH PREDICTIONS:\n";
      if (predictions.Childbirth && predictions.Childbirth.length > 0) {
        predictions.Childbirth.forEach(p => {
          output += `- ${p}\n`;
        });
      } else {
        output += "- No specific childbirth predictions were found based on the available rules.\n";
      }

      // Format Health Predictions
      output += "\nHEALTH PREDICTIONS:\n";
      if (predictions.Health && predictions.Health.length > 0) {
        predictions.Health.forEach(p => {
          output += `- ${p}\n`;
        });
      } else {
        output += "- No specific health yogas or conditions were identified based on the available rules.\n";
      }
      createCard('Child Birth and Health', output, 'text');
      return output;
    }
    /**
 * Provides astrological predictions based on horoscope data.
 * The logic is derived from the provided source materials on Bhrigu Nandi Nadi astrology.
 * 
 * @param {object} horoscope - The horoscope data object.
 * @returns {object} An object containing arrays of predictions for Childbirth and Health.
 */
    function getChildBirthHealthPredictions(horoscope) {
      // --- Helper Data & Functions ---

      const signNames = {
        1: "Aries", 2: "Taurus", 3: "Gemini", 4: "Cancer", 5: "Leo",
        6: "Virgo", 7: "Libra", 8: "Scorpio", 9: "Sagittarius",
        10: "Capricorn", 11: "Aquarius", 12: "Pisces"
      };

      const getPlanetsInSign = (signNumber) => {
        let planets = [];
        for (const planet in horoscope) {
          if (horoscope[planet].sign === signNumber) {
            planets.push(planet);
          }
        }
        return planets;
      };

      const getHouseFromJupiter = (targetHouse) => {
        const jupiterHouse = horoscope.Jupiter.house;
        // Calculate the target house number, wrapping around if it exceeds 12
        return (jupiterHouse + targetHouse - 2) % 12 + 1;
      };

      const getPlanetsInHouse = (houseNumber) => {
        let planets = [];
        for (const planet in horoscope) {
          if (horoscope[planet].house === houseNumber) {
            planets.push(planet);
          }
        }
        return planets;
      };

      const checkCombination = (planetNames) => {
        // First, ensure all planets in the combination exist in the horoscope.
        for (const planet of planetNames) {
          if (!horoscope[planet]) {
            return false;
          }
          // Get the house number of the first planet in the list.
          const firstPlanetHouse = horoscope[planet].house;
          const houses = planetNames.map(p => horoscope[p].house);

          // --- Check 1: Are all planets in the same house (Conjunction)? ---
          const allInSameHouse = houses.every(house => house === firstPlanetHouse);
          if (allInSameHouse) {
            return true;
          }

          // --- Check 2: Are all planets in the same trine? ---
          // Trine houses from the first planet's house are: house, house+4, house+8 (wrapping around 12)
          const trineHouses = [
            firstPlanetHouse,
            (firstPlanetHouse + 4 - 1) % 12 + 1, // 5th house from the first planet
            (firstPlanetHouse + 8 - 1) % 12 + 1  // 9th house from the first planet
          ];

          // Check if every planet's house is one of these trine houses.
          const allInSameTrine = houses.every(house => trineHouses.includes(house));
          if (allInSameTrine) {
            return true;
          }
        }
        // If neither condition is met, the combination is not present.
        return false;
      }
      // --- Main Prediction Logic ---

      let predictions = {
        Childbirth: [],
        Health: []
      };

      // 1. Childbirth Predictions [1, 2]
      const fifthHouseFromJupiter = getHouseFromJupiter(5);
      const planetsInFifthFromJu = getPlanetsInHouse(fifthHouseFromJupiter);

      if (planetsInFifthFromJu.length > 0) {
        planetsInFifthFromJu.forEach(planet => {
          switch (planet) {
            case 'Ketu':
              predictions.Childbirth.push("Ketu in the 5th house from Jupiter can signify miscarriage or no childbirth. [2]");
              break;
            case 'Rahu':
              predictions.Childbirth.push("Rahu in the 5th house from Jupiter can signify delay, adoption, or a child after specific pujas (pitra/sarp dosh). [2]");
              break;
            case 'Saturn':
              predictions.Childbirth.push("Saturn in the 5th house from Jupiter can signify delay in childbirth (after 32 years of age). Severe delays could lead to denial. [2]");
              break;
            case 'Moon':
              predictions.Childbirth.push("Moon in the 5th house from Jupiter can signify adoption. [2]");
              break;
          }
        });
      } else {
        // RULE 2: If there is no planet in 5th house see the 7th aspect/dristi on 5th house from Jupiter [1].
        // The house that is 7th from a target house is the house opposite to it.
        const houseAspectingFifth = (fifthHouseFromJupiter + 6 - 1) % 12 + 1;
        const aspectingPlanets = getPlanetsInHouse(houseAspectingFifth);

        if (aspectingPlanets.length > 0) {
          aspectingPlanets.forEach(planet => {
            let planetHouse = horoscope[planet].house;
            switch (planet) {
              case 'Ketu':
                predictions.Childbirth.push(`Ketu is aspecting the 5th house from Jupiter (from house ${planetHouse}), which can signify miscarriage or no childbirth [1, 2].`);
                break;
              case 'Rahu':
                predictions.Childbirth.push(`Rahu is aspecting the 5th house from Jupiter (from house ${planetHouse}), which can signify delay, adoption, or a child after specific pujas [1, 2].`);
                break;
              case 'Saturn':
                predictions.Childbirth.push(`Saturn is aspecting the 5th house from Jupiter (from house ${planetHouse}), which can signify delay in childbirth (after 32 years of age) [1, 2].`);
                break;
              case 'Moon':
                predictions.Childbirth.push(`Moon is aspecting the 5th house from Jupiter (from house ${planetHouse}), which can signify adoption [1, 2].`);
                break;
              default:
                predictions.Childbirth.push(`${planet} is aspecting the 5th house from Jupiter (from house ${planetHouse}). The specific outcome for this aspect is not detailed in the sources.`);
                break;
            }
          });
        } else {
          // RULE 3: If no planet is Aspecting, then we will see 5th lord... [1].
          predictions.Childbirth.push("No planet is in the 5th house from Jupiter, and no planets are aspecting it from the 7th position. Further analysis of the 5th lord is required [1].");
        }
      }


      // 2. Childbirth Problem Possibility (Planets in Libra) [3-5]
      const planetsInLibra = getPlanetsInSign(7);
      if (planetsInLibra.length > 0) {
        planetsInLibra.forEach(planet => {
          switch (planet) {
            case 'Sun':
              predictions.Childbirth.push("Sun in Libra: May indicate low sperm count in males or issues with egg cells/ovaries in females. [3]");
              break;
            case 'Moon':
              predictions.Childbirth.push("Moon in Libra: Can cause early ejaculation or low sperm count in males, and menstrual cycle problems in females. [3]");
              break;
            case 'Mars':
              predictions.Childbirth.push("Mars in Libra: Indicates strong sperm in males, but may suggest surgical delivery or issues with bed pleasure for females. [3]");
              break;
            case 'Mercury':
              predictions.Childbirth.push("Mercury in Libra: Suggests no major issues, but possibly less interest in sexual activity. [3]");
              break;
            case 'Venus':
              predictions.Childbirth.push("Venus in Libra: Generally no major problem, though males might have a slightly lower sperm count and females may have white discharge. [4]");
              break;
            case 'Saturn':
              predictions.Childbirth.push("Saturn in Libra: Can indicate problems with sperm count in males or uterine issues and delays for females. [4]");
              break;
            case 'Rahu':
              predictions.Childbirth.push("Rahu in Libra: May cause dryness in sperm counts for males and ovary problems for females. [4]");
              break;
            case 'Ketu':
              predictions.Childbirth.push("Ketu in Libra: Suggests a need for medical attention like IVF for males. [4]");
              break;
            case 'Jupiter':
              predictions.Childbirth.push("Jupiter in Libra: Indicates no problem in childbirth unless it is afflicted by multiple malefic planets. [5]");
              break;
          }
        });
      }

      // 3. General Health Predictions based on Jupiter's connections [6]
      const jupiterSign = horoscope.Jupiter.sign;
      const planetsInJupiterSign = getPlanetsInSign(jupiterSign);

      if (planetsInJupiterSign.includes('Mars')) predictions.Health.push("Jupiter with Mars indicates a possibility of surgery, accidents, or health issues. [6]");
      if (planetsInJupiterSign.includes('Rahu')) predictions.Health.push("Jupiter with Rahu can be dangerous in the first year and suggest ill health throughout life. [6]");
      if (planetsInJupiterSign.includes('Ketu')) predictions.Health.push("Jupiter with Ketu indicates potential for blockages and surgeries. [6]");
      if (planetsInJupiterSign.includes('Venus')) predictions.Health.push("Jupiter with Venus suggests the possibility of lifelong medication. [6]");

      // 4. Health Yogas (Planetary Combinations) [7, 8]
      if (checkCombination(['Rahu', 'Mercury', 'Mars'])) predictions.Health.push("Yoga for spinal cord problems (Rahu + Mercury + Mars). [7]");
      if (checkCombination(['Sun', 'Moon', 'Rahu', 'Saturn'])) predictions.Health.push("Yoga for migraine/headache (Sun + Moon + Rahu + Saturn). [7]");
      if (checkCombination(['Mercury', 'Moon'])) predictions.Health.push("Yoga for thyroid or throat issues (Mercury + Moon). [7]");
      if (checkCombination(['Mercury', 'Moon', 'Venus'])) predictions.Health.push("Yoga for thyroid issues (Mercury + Moon + Venus). [7]");
      if (checkCombination(['Rahu', 'Mercury', 'Jupiter'])) predictions.Health.push("Yoga for ear disease (Rahu + Mercury + Jupiter). [7]");
      if (checkCombination(['Saturn', 'Rahu', 'Mars'])) predictions.Health.push("Cancer yoga or decaying of teeth (Saturn + Rahu + Mars). [7]");
      if (checkCombination(['Saturn', 'Moon']) || checkCombination(['Rahu', 'Moon']) || checkCombination(['Ketu', 'Moon']) || checkCombination(['Saturn', 'Sun']) || checkCombination(['Rahu', 'Sun']) || checkCombination(['Ketu', 'Sun'])) {
        predictions.Health.push("Yoga for trouble in eyes (Saturn/Rahu/Ketu with Moon/Sun). [7]");
      }
      if (checkCombination(['Saturn', 'Moon', 'Ketu'])) predictions.Health.push("Yoga for asthma or breathing issues (Saturn + Moon + Ketu). [8]");
      if (checkCombination(['Mars', 'Moon', 'Rahu'])) predictions.Health.push("Yoga for blood impurities, infection, or cancer (Mars + Moon + Rahu). [8]");
      if (checkCombination(['Jupiter', 'Mars']) || checkCombination(['Jupiter', 'Ketu'])) predictions.Health.push("Yoga for blood pressure (Jupiter + Mars/Ketu). [8]");
      if (checkCombination(['Sun', 'Saturn']) || checkCombination(['Mars', 'Saturn'])) predictions.Health.push("Yoga for arthritis or joint pain (Sun/Mars + Saturn). [8]");
      if (checkCombination(['Moon', 'Rahu']) || checkCombination(['Moon', 'Ketu'])) predictions.Health.push("Yoga for psychological problems (Moon + Rahu/Ketu). [8]");

      return predictions;
    }
    /**
     * Determines predictions based on the 51 Unknown Facts about Sun rules (Bhrigu Nandi Nadi principles).
     * Uses the structure: { Sun: { sign: X, house: Y }, ... }
     * 
     * NOTE: The logic relies on Graha Drishti rules from BPHS/Uttara Kalamrita for aspects [10-12].
     * The source material does not provide specific coding instructions; this is a logical implementation.
     * @param {object} horoscope - The chart data containing planet placements (house and sign).
     * @returns {Array<string>} - A list of generated predictions.
     */
    function determineSunPredictions(horoscope) {
      const { Sun, Moon, Mars, Mercury, Venus, Jupiter, Saturn, Rahu, Ketu } = horoscope;
      const predictions = [];
      const lordshipMap = {
        Sun: [5],      // Leo
        Moon: [4],     // Cancer
        Mars: [1, 8],    // Aries, Scorpio
        Mercury: [3, 6],   // Gemini, Virgo
        Venus: [2, 7],    // Taurus, Libra
        Jupiter: [9, 12],  // Sagittarius, Pisces
        Saturn: [10, 11]  // Capricorn, Aquarius
      };
      // --- Utility Functions ---
      /**
         * Checks for a Rashi exchange (Parivartana Yoga) between two planets.
         * P1 is in P2's sign AND P2 is in P1's sign.
         */
      const checkExchange = (P1_name, P1_data, P2_name, P2_data) => {
        // 1. Get the signs ruled by P1 and P2
        const P1_rashi_signs = lordshipMap[P1_name]; // e.g., Sun: [2]
        const P2_rashi_signs = lordshipMap[P2_name]; // e.g., Jupiter: [10, 11]

        if (!P1_rashi_signs || !P2_rashi_signs) return false;

        // 2. Condition A: P1 is in a sign ruled by P2
        const P1_in_P2_sign = P2_rashi_signs.includes(P1_data.sign);

        // 3. Condition B: P2 is in a sign ruled by P1
        const P2_in_P1_sign = P1_rashi_signs.includes(P2_data.sign);

        return P1_in_P2_sign && P2_in_P1_sign;
      };
      // Checks if two planets are in the same house
      const isConjunction = (P1, P2) => P1.house === P2.house;

      // Calculates house distance (1 to 12) from P1 to P2
      const getRelativeHouse = (P1, P2) => ((P2.house - P1.house + 12) % 12) + 1;

      // Helper to check if a planet is in a specific Rashi
      const isInRashi = (P, signId) => P.sign === signId;

      /**
       * Checks if Planet P1 aspects the target house.
       * Special aspect houses: Mars (4, 8), Jupiter (5, 9), Saturn (3, 10), Nodes (5, 9). 7th is universal [11].
       */
      const isAspectedBy = (P1, targetHouse, specialAspects = []) => {
        // All planets aspect the 7th house [13]
        const universalAspect = ((P1.house + 6) % 12) + 1;
        let aspectHouses = [universalAspect];

        // Add special aspects if applicable
        const relativeAspects = specialAspects.map(a => ((P1.house + a - 1 - 1 + 12) % 12) + 1);
        aspectHouses = aspectHouses.concat(relativeAspects);

        return aspectHouses.includes(targetHouse);
      };

      // --- Planetary Aspect Configuration based on Source [11, 12, 14] ---
      const aspectConfig = {
        Mars: [4, 7, 8],
        Jupiter: [5, 7, 9],
        Saturn: [3, 7, 10],
        Rahu: [5, 7, 9],
        Ketu: [5, 7, 9],
        Sun: [7],
        Moon: [7],
        Mercury: [7],
        Venus: [7]
      };

      // --- Implementation of the 51 Rules ---

      // A. Rules Related to Family and Father's Status/Profession (Rules 1-35)

      // 1. Sun has Ve and Mo in successive Houses [1]
      if (getRelativeHouse(Sun, Venus) === 2 && getRelativeHouse(Venus, Moon) === 2) {
        predictions.push("The person may be the son of the 2nd wife of his father.");
      }

      // 2. Sun next to Venus (Ve in 2nd house from Su) [1]
      if (getRelativeHouse(Sun, Venus) === 2) {
        predictions.push("Wife is devotional.");
      }

      // 3. Sun has Ve in 2nd house and Ju aspects Venus [1]
      const VeIn2ndFromSun = getRelativeHouse(Sun, Venus) === 2;
      const JuAspectsVe = isAspectedBy(Jupiter, Venus.house, aspectConfig.Jupiter);
      if (VeIn2ndFromSun && JuAspectsVe) {
        predictions.push("The native and his father will be in the same profession.");
      }

      // 4. Sun and Mercury hemmed between Mars and Venus [1, 2]
      if (isConjunction(Sun, Mercury) && getRelativeHouse(Mars, Sun) === 12 && getRelativeHouse(Sun, Venus) === 2) {
        predictions.push("Father of the native had to undergo a surgery in middle of his age.");
      }

      // 5. Sun with Saturn in Leo (Sign 5) [2]
      if (isConjunction(Sun, Saturn) && isInRashi(Sun, 5)) {
        predictions.push("The native will have a Govt. Job.");
      }

      // 6. Jupiter has Sun and Me in 2nd House [2]
      if (isConjunction(Sun, Mercury) && getRelativeHouse(Jupiter, Sun) === 2) {
        predictions.push("The native and Father can have the same education.");
      }

      // 7. Sun in Taurus (Sign 2) [2]
      if (isInRashi(Sun, 2)) {
        predictions.push("The mother of native is faithful to native’s father.");
      }

      // 8. Su and Me behind Ju in Sagittarius (Sign 9) [2]
      if (isConjunction(Sun, Mercury) && getRelativeHouse(Sun, Jupiter) === 12 && isInRashi(Jupiter, 9)) {
        predictions.push("The native is born in a noble family. The Father and grandfather are learned people.");
      }

      // 9. Sun and Rahu together [2]
      if (isConjunction(Sun, Rahu)) {
        predictions.push("Father’s married life may have issues.");
      }

      // 10. Sun in Ju rashi (Sagittarius=9 or Pisces=12) with mercury [3]
      if (isConjunction(Sun, Mercury) && (isInRashi(Sun, 9) || isInRashi(Sun, 12))) {
        predictions.push("Father will be godly and learned.");
      }

      // 11. Sun placed between 2 enimical planets [3] (Requires defined enemy list; skipped for precise definition)

      // 12. Sun has Ketu, Mercury, Venus in 2nd house [3]
      if (getRelativeHouse(Sun, Ketu) === 2 && getRelativeHouse(Sun, Mercury) === 2 && getRelativeHouse(Sun, Venus) === 2) {
        predictions.push("Father can have agricultural income.");
      }

      // 13. Sun in Aries (Sign 1), Ve in Pisces (Sign 12) [3]
      if (isInRashi(Sun, 1) && isInRashi(Venus, 12)) {
        predictions.push("Native’s father will be working in high govt. position.");
      }

      // 14. Mars in 2nd house from Sun [3]
      if (getRelativeHouse(Sun, Mars) === 2) {
        predictions.push("Father may have rental income, Mars related source of income.");
      }

      // 15. Jupiter in cancer (Sign 4) and Sun is exalted (Aries, Sign 1) [3]
      if (isInRashi(Jupiter, 4) && isInRashi(Sun, 1)) {
        predictions.push("Native may have topmost position.");
      }

      // 16. Sun, Saturn and Moon together and Rahu in 2nd to them [4]
      if (isConjunction(Sun, Saturn) && isConjunction(Sun, Moon) && getRelativeHouse(Sun, Rahu) === 2) {
        predictions.push("Father will be a dealer in sweets.");
      }

      // 17. Sun’s 10th house aspected by Mars [4]
      const Sun10thHouse = ((Sun.house + 9) % 12) + 1;
      if (isAspectedBy(Mars, Sun10thHouse, aspectConfig.Mars)) {
        predictions.push("Father can be in Govt. Job.");
      }

      // 18. Sun has Mars and Rahu in 2nd and Saturn in 3rd [4]
      if (getRelativeHouse(Sun, Mars) === 2 && getRelativeHouse(Sun, Rahu) === 2 && getRelativeHouse(Sun, Saturn) === 3) {
        predictions.push("Father may have a low salaried job.");
      }

      // 19. Sun in Cancer (Sign 4) [4]
      if (isInRashi(Sun, 4)) {
        predictions.push("Native’s father can settle down with in laws.");
      }

      // 20. Sun’s 12th house aspected by Saturn [4]
      const Sun12thHouse = ((Sun.house + 11) % 12) + 1;
      if (isAspectedBy(Saturn, Sun12thHouse, aspectConfig.Saturn)) {
        predictions.push("Father will have lot of problems because of bad company.");
      }

      // 21. Sun in Aries and Ve in Taurus [5]
      if (isInRashi(Sun, 1) && isInRashi(Venus, 2)) {
        predictions.push("Father is master of arts and rich.");
      }

      // 22. Sun and Mars in 7th house from Jupiter [5]
      if (getRelativeHouse(Jupiter, Sun) === 7 && getRelativeHouse(Jupiter, Mars) === 7) {
        predictions.push("Native will have unhappy married life.");
      }

      // 23. Sun has Ve and Ra in 2nd house [5]
      if (getRelativeHouse(Sun, Venus) === 2 && getRelativeHouse(Sun, Rahu) === 2) {
        predictions.push("The native’s father can have a mistress.");
      }

      // 24. Sun has no planets in either houses (12th and 2nd from Sun) [5]
      // Complex: Requires checking ALL planet houses. Assume simplified check for the 9 defined planets.
      const planets = [Moon, Mars, Mercury, Venus, Jupiter, Saturn, Rahu, Ketu];
      const house12 = ((Sun.house + 11) % 12) + 1;
      const house2 = ((Sun.house + 1) % 12) + 1;
      const is12thEmpty = planets.every(p => p.house !== house12);
      const is2ndEmpty = planets.every(p => p.house !== house2);

      if (is12thEmpty && is2ndEmpty) {
        predictions.push("Father will have problems.");
      }

      // 25. Sun in debilitation (Sign 7, Libra) [5]
      if (isInRashi(Sun, 7)) {
        predictions.push("Father had lot of problems at the time of native’s birth.");
      }

      // 26. Sun touches 1st Sa then Ketu in its movements [5] (Requires transit logic; placeholder)

      // 27. Sun in Leo (Sign 5) and Me in Virgo (Sign 6) [5]
      if (isInRashi(Sun, 5) && isInRashi(Mercury, 6)) {
        predictions.push("Father may work for cooperative firm.");
      }

      // 28. If 10th rashi from Sun is ruled by Mars (Aries=1 or Scorpio=8) [6]
      const Rashi10thFromSun = (Sun.sign + 9 > 12) ? Sun.sign + 9 - 12 : Sun.sign + 9;
      if (Rashi10thFromSun === 1 || Rashi10thFromSun === 8) {
        predictions.push("Father may be a govt. employee.");
      }

      // 29. 2nd lord from Sun sits with Ve or Ketu [6] (Requires identifying the Rashi Lord; skipped)

      // 30. Sun and Venus conjunction [6]
      if (isConjunction(Sun, Venus)) {
        predictions.push("No happiness from Money or marriage.");
      }

      // 31. Sun with Me and Ma Aspected by Sa and Ju [6]
      const SunMeMaConjunction = isConjunction(Sun, Mercury) && isConjunction(Sun, Mars);
      const house = Sun.house;
      const SaAspects = isAspectedBy(Saturn, house, aspectConfig.Saturn);
      const JuAspects = isAspectedBy(Jupiter, house, aspectConfig.Jupiter);
      if (SunMeMaConjunction && SaAspects && JuAspects) {
        predictions.push("The native’s business may receive government aids.");
      }

      // 32. Sun in 12th house to Jupiter [6]
      if (getRelativeHouse(Jupiter, Sun) === 12) {
        predictions.push("Birthplace of native is near temple.");
      }

      // 33. Sun has Ju and Sa in 2nd House [6]
      if (getRelativeHouse(Sun, Jupiter) === 2 && getRelativeHouse(Sun, Saturn) === 2) {
        predictions.push("Native and Father may carry on same profession.");
      }

      // 34. Sun and Jupiter exchange [7] (Requires Rashi exchange check; skipped)

      // 35. Sun in Capricorn (10), Rahu in 2nd house (relative to Su), and Sa in Virgo(6)/Gemini(3) [7]
      if (isInRashi(Sun, 10) && getRelativeHouse(Sun, Rahu) === 2 && (isInRashi(Saturn, 6) || isInRashi(Saturn, 3))) {
        predictions.push("Native’s father has to face lot of legal problems.");
      }

      // B. Rules Related to Birthplace (Rules 36, 32)

      // 36. Sun in Pisces (Sign 12) [7]
      if (isInRashi(Sun, 12)) {
        predictions.push("Birthplace of native is near cremation ground or Ashram");
      }

      // C. Rules Related to Native's Physical Characteristics (Rules 37-48) [7-9]

      // 43. Sun in Aries (Sign 1) [8]
      if (isInRashi(Sun, 1)) { predictions.push("Head problems , migraine , hair loss."); }

      // 37. Sun in Taurus (Sign 2) [7]
      if (isInRashi(Sun, 2)) { predictions.push("Native will have reddish face and harsh voice."); }

      // 42. Sun in Gemini (Sign 3) [8]
      if (isInRashi(Sun, 3)) { predictions.push("Native will have strong shoulders and arms."); }

      // 38. Sun in Cancer (Sign 4) [7]
      if (isInRashi(Sun, 4)) { predictions.push("Native will have strong heartbeats and problems to chest."); }

      // 39. Sun in Leo (Sign 5) [7]
      if (isInRashi(Sun, 5)) { predictions.push("Very good appetitite"); }

      // 40. Sun in Virgo (Sign 6) [8]
      if (isInRashi(Sun, 6)) { predictions.push("Native can have abs(intestinal muscles)"); }

      // 41. Sun in Libra (Sign 7) [8]
      if (isInRashi(Sun, 7)) { predictions.push("Native will have a good-looking body"); }

      // 44. Sun in Scorpio (Sign 8) [8]
      if (isInRashi(Sun, 8)) { predictions.push("Excess urination and problems in genitals"); }

      // 45. Sun in Sagittarius (Sign 9) [8]
      if (isInRashi(Sun, 9)) { predictions.push("Native will have good shaped thighs and hips"); }

      // 46. Sun in Capricorn (Sign 10) [8]
      if (isInRashi(Sun, 10)) { predictions.push("Native will have large knee caps and issues in them"); }

      // 47. Sun in Aquarius (Sign 11) [9]
      if (isInRashi(Sun, 11)) { predictions.push("Native will have good calve muscels"); }

      // 48. Sun in Pisces (Sign 12) [9]
      if (isInRashi(Sun, 12)) { predictions.push("Strong Feet"); }

      // D. Miscellaneous and Specific Father/Danger Rules (Rules 49-51)

      // 49. Sun in exaltation (Sign 1, Aries) and no planet behind (12th house from Sun is empty) [9]
      if (isInRashi(Sun, 1) && is12thEmpty) {
        predictions.push("Native’s father had struggled a lot to gain position.");
      }

      // 50. Sun with Sa And Ra in Mars rashi (Aries=1 or Scorpio=8) [9]
      if (isConjunction(Sun, Saturn) && isConjunction(Sun, Rahu) && (isInRashi(Sun, 1) || isInRashi(Sun, 8))) {
        predictions.push("Father will have old ancestral property.");
      }

      // 51. Sun in debilitation (Sign 7, Libra) and Ra in Leo (Sign 5) [9]
      if (isInRashi(Sun, 7) && isInRashi(Rahu, 5)) {
        predictions.push("Father will face great danger , when Ju touches Leo");
      }
      createCard('Sun Aspects', predictions, 'text');
      return predictions;
    }


    /**
     * Generates predictions based on Moon's placement relative to Jupiter (Moon in Different Houses from Jupiter).
     * @param {object} horoscope - Chart data including Moon and Jupiter placements.
     * @returns {Array<string>} - List of generated predictions.
     */
    function predictMoonFromJupiter(horoscope) {
      const { Moon, Jupiter } = horoscope;
      const predictions = [];

      // Calculates house distance (1 to 12) from P1 (Jupiter) to P2 (Moon)
      const getRelativeHouse = (P1, P2) => ((P2.house - P1.house + 12) % 12) + 1;

      const relativeHouse = getRelativeHouse(Jupiter, Moon);

      // Common prediction when Moon is good (Implied general benefic influence of Ju on Mo) [1]
      predictions.push("Moon becomes good, all karakas of Moon enhance (Food, goods, changes, nurture, care, Mother, Mind, Emotions) [1].");
      predictions.push("Jupiter feels like it is exalted [1].");
      predictions.push("Person is open hearted and has empathy and care for others [1].");
      predictions.push("Mother is religious and pious and auspicious [1].");
      predictions.push("Jeev and Mother look alike [1].");
      predictions.push("Native's mind will be good and pious [1].");

      switch (relativeHouse) {
        case 1: // Moon in 1st House from Jupiter [3]
          predictions.push("Native may enter family life soon [3].");
          predictions.push("Native's speech is soft and speaks fast and softly [3].");
          predictions.push("Finance is inflow and outflow of money; no savings, no financial crisis [3].");
          predictions.push("Difference of opinion with Mother [3].");
          predictions.push("Mother has Jupiter in the 12th House from her Lagna; Mother does expenditure on religious things [3].");
          predictions.push("Children can settle in different land for their profession [3].");
          break;

        case 2: // Moon in 2nd House from Jupiter [4]
          predictions.push("Person has karma related to Mother and Elder Sister or Daughter [4].");
          break;

        case 3: // Moon in 3rd House from Jupiter [4, 5]
          predictions.push("Less Inner Strength, Emotional [4].");
          predictions.push("Very good orator, Fast communication [4].");
          predictions.push("Travel: Unplanned, sudden [4].");
          predictions.push("Skills: Good drawing and writing, fast writers [4].");
          predictions.push("Mother will give you support (3rd house planet gives support) [4].");
          predictions.push("Person will get blames/scandal for what he has not done [4].");
          predictions.push("Relationship with mother will be friendly [4].");
          predictions.push("Mother of native may have an elder brother [4].");
          predictions.push("Mother has good friends, may have a sister [4].");
          predictions.push("For Stability, the person should worship goddess Parvati [5].");
          break;

        case 4: // Moon in 4th House from Jupiter [5, 6]
          predictions.push("Mother may be engaged in teaching, preaching, religious activities, maybe working in a school [5].");
          predictions.push("Mother's Father will be a pious personality [5].");
          predictions.push("Native's life has Ghar ka sukh (domestic happiness) [5].");
          predictions.push("Native may change his houses and vehicles – Twice or Thrice [5].");
          predictions.push("Education can have a lot of changes and travels, Can study at distant land, economics, psychology, hospitality [6].");
          break;

        case 5: // Moon in 5th House from Jupiter [6, 7]
          predictions.push("Can have a girl child [6].");
          predictions.push("Considered little malefic here; can cause delay in child birth due to stree curse [6].");
          predictions.push("5th house from Jupiter shows atma is interested in Travels, Nurturing others [6].");
          predictions.push("Native will be lucky for mother [7].");
          predictions.push("Can signify adoption/IVF [7].");
          predictions.push("Father may suffer memory related issues or depression [7].");
          predictions.push("Friendships will not last very long [7].");
          break;

        case 6: // Moon in 6th House from Jupiter [7]
          predictions.push("Diseases are not long lasting [7].");
          predictions.push("Difference of opinion from Mother [7].");
          predictions.push("Servants (People that work under you) get blames; they don't stay for long [7].");
          predictions.push("Open enemy is weak but cunning [7].");
          predictions.push("Mother's longevity is good [7].");
          predictions.push("Diseases can be cold, cough, insomnia, depression, memory problems [7].");
          break;

        case 7: // Moon in 7th House from Jupiter [8]
          predictions.push("Friends and Partners are good and pious, maybe fluctuating in nature, emotional friends [8].");
          predictions.push("Day to day activity will be fast and unplanned [8].");
          predictions.push("Native will be having good thoughts, but is subject to a lot of changes in his life [8].");
          break;

        case 8: // Moon in 8th House from Jupiter [8, 9]
          predictions.push("Loose money all throughout life (Aspects 2nd house) [8].");
          predictions.push("Name, Longevity is good, but may have memory, depression, sleep related problems [8].");
          predictions.push("Difference of opinion with Mother [8].");
          predictions.push("Mother if falls sick it is for long time [9].");
          predictions.push("Friends maybe working in abroad [9].");
          predictions.push("Keep donating articles of planets in 8th to Jupiter [9].");
          break;

        case 9: // Moon in 9th House from Jupiter [9, 10]
          predictions.push("Long distance travels all of a sudden [9].");
          predictions.push("Second Child will be good, will care for you in your last days [10].");
          predictions.push("Post graduation can be from different land [10].");
          predictions.push("Sudden good change in luck of native [10].");
          predictions.push("Person may travel to distant place in search of Guru [10].");
          break;

        case 10: // Moon in 10th House from Jupiter [10]
          predictions.push("Changes in Profession [10].");
          predictions.push("Change of place for Father [10].");
          predictions.push("Mother has Jupiter in the 4th house, so gives her Ghar ka Sukh [10].");
          predictions.push("Native's Karma is Linked to Mother, Elder sister or Daughter or in Nurture care and service of people [10].");
          predictions.push("Person can go abroad, may have Foreign clients and will be able to get rid of his debt through them [10].");
          break;

        case 11: // Moon in 11th House from Jupiter [10, 11]
          predictions.push("Native can have elder sister; she will be good [11].");
          predictions.push("Native may have a lot of friends, but friendships don't last for long [11].");
          predictions.push("Gains are also coming and going [11].");
          predictions.push("Friendly relations with Mother [11].");
          predictions.push("Jupiter becomes powerful by this placement [11].");
          predictions.push("Mother may be daily temple going [11].");
          predictions.push("Mother may have a younger brother; Mother may have short travels to Religious places [11].");
          break;

        case 12: // Moon in 12th House from Jupiter [2, 11]
          predictions.push("Weak secret enemy (will be weak and not stay for long) [11].");
          predictions.push("Difference of opinion with Mother [11].");
          predictions.push("Mother will be faithful [2].");
          predictions.push("Secret loans of native – which nobody knows about [2].");
          predictions.push("Fast expenses and savings becomes problematic [2].");
          predictions.push("Finances and Family life of Mother is good [2].");
          break;

        default:
          // This case should not be reached in a 1-12 house system
          break;
      }
      createCard('Moon from Jupiter', predictions, 'text');
      return predictions;
    }

    /**
     * Maps Rashi numbers (1=Aries, 12=Pisces) to their Vedic astrological names.
     */
    const rashiNameMap = {
      1: "Aries (Mesha)",
      2: "Taurus (Vrishabha)",
      3: "Gemini (Mithuna)",
      4: "Cancer (Karka)",
      5: "Leo (Simha)",
      6: "Virgo (Kanya)",
      7: "Libra (Tula)",
      8: "Scorpio (Vrischika)",
      9: "Sagittarius (Dhanu)",
      10: "Capricorn (Makara)",
      11: "Aquarius (Kumbha)",
      12: "Pisces (Meena)"
    };

    /**
     * Astrological predictions for Moon in different Rashis, derived from the source material.
     * Data is indexed by Rashi number (1 to 12).
     */
    const moonRashiPredictions = {
      1: { // Aries
        rashi: "Aries (Mesha)",
        status: null,
        mother_traits: [
          "Will be courageous [1]",
          "Will be stubborn [1]",
          "Can have accident or surgeries [2]",
          "Is called Miss Fatafat [2]",
          "May be Miser [2]"
        ],
        native_traits: [
          "Mental ability is restricted due to stubbornness [1]",
          "Is self centered in thoughts [1]",
          "Has sympathy towards people in trouble but may not help them [1]",
          "Gives sexual desires and attraction towards opposite sex (mainly in male chart) [1]"
        ],
        combinations: [
          "Mo in Aries is considered Mo + Ma (Good for land property) [1]"
        ]
      },
      2: { // Taurus
        rashi: "Taurus (Vrishabha)",
        status: "Exalted here [2]",
        mother_traits: [
          "Will be money minded [2]",
          "May even work in financial institution like bank [2]",
          "Can be of artistic nature [2]",
          "Is influential and respected and loved by all [2]",
          "Will have wealth [2]",
          "Is fond of Luxurious things and articles [2]"
        ],
        native_traits: [
          "Mind does not think small and thinks he/she is great [2]",
          "Is attractive in appearance [2]",
          "Money comes and goes fast [3]",
          "May gain money after birth of Daughter [2]"
        ],
        combinations: []
      },
      3: { // Gemini
        rashi: "Gemini (Mithuna)",
        status: null,
        mother_traits: [
          "Will be intelligent, educated, and have good communication skills [3]",
          "Is diplomatic, and she knows how to get things done [3]"
        ],
        native_traits: [
          "Mind is analytical and calculative [3]",
          "Has good memory and remembers everything (unless moon is weak) [3]",
          "May face cheating and fraud in friendships and partnerships [3]",
          "Will do well in business [3]"
        ],
        combinations: [
          "Mo is dispositor of Me so Me will carry moon’s energy [3]"
        ]
      },
      4: { // Cancer
        rashi: "Cancer (Karka)",
        status: "Own House (Implied by context, though not explicitly stated in the Cancer section, but mentioned in general Moon Karakas [12])",
        mother_traits: [
          "Will see lot of changes in her life [4]",
          "Has good thoughts [4]",
          "Is nurturing and empathetic and she is truly motherly in nature [4]"
        ],
        native_traits: [
          "Is fickle minded [4]",
          "Is Philanthropic in Nature and a lover of art [4]"
        ],
        combinations: []
      },
      5: { // Leo
        rashi: "Leo (Simha)",
        status: null,
        mother_traits: [
          "Will have control of Family, Head of Family [4]",
          "Will Rule and enjoys authority [4]"
        ],
        native_traits: [
          "Mind is practical and talks definitive and to the point [4]",
          "Has royal thought, and likes things that are royal, branded and Luxurious [4, 5]",
          "Is Strong minded and faces [challenges] [5]",
          "Father and Son may encounter frequent changes and travels [5]",
          "Elder sister will be dominating and egoistic [4]"
        ],
        combinations: [
          "As Leo being Mooltrikon Rashi of Su makes it as Su + Mo combination [5]"
        ]
      },
      6: { // Virgo
        rashi: "Virgo (Kanya)",
        status: null,
        mother_traits: [
          "Is well versed in communication [5]",
          "Will be educated and highly Intelligent [5]",
          "May find errors and faults in everything (Virgo signifies Nukta-Chini and analytical skills) [5]",
          "Tries to accumulate wealth in as much quantity as possible [5]"
        ],
        native_traits: [
          "Is intelligent, sharp and has large memory [5]",
          "Has good mixing abilities with members of society [5]",
          "Will be of Competitive, Jealous nature [6]"
        ],
        combinations: [
          "Virgo is Mooltrikon of Me, Makes it a Mo + Me combination, which indulges a person [6]"
        ]
      },
      7: { // Libra
        rashi: "Libra (Tula)",
        status: null,
        mother_traits: [
          "Has tendency to hoard wealth (Money minded) [6]",
          "Is fond of luxurious things and articles [6]",
          "Faced a downfall, problems, issues after your birth (as Mo is approaching debilitation) [6]",
          "This combination is sometimes found in charts of Widows and signifies struggle for mother [7]"
        ],
        native_traits: [
          "Mind has lot of desires [6]",
          "Has sexual desires and is attracted towards opposite sex [6]",
          "May not have large savings [6]"
        ],
        combinations: [
          "Mo in Libra (Mooltrikon rashi of Ve makes it a Mo + Ve combination) [6]"
        ]
      },
      8: { // Scorpio
        rashi: "Scorpio (Vrischika)",
        status: "Debilitated here [7]",
        mother_traits: [
          "Is very stubborn [7]",
          "Sometimes says words that are arrow like and hurtful (Mo + Ma + Ke) [7]",
          "Is miser [7]",
          "Had a hard struggle in her life which made her a Hard nut [7]",
          "Is not affected by happenings and problems of other people [7]",
          "Is spiritually inclined [7]"
        ],
        native_traits: [
          "Has interest in unproductive things [8]",
          "Starts preaching others about right and wrong [8]",
          "Is mysterious in nature and has invisible qualities of 8th house [8]",
          "Mind of Male native may have a lot of sexual thoughts (violent and unethical too) [8]"
        ],
        combinations: []
      },
      9: { // Sagittarius
        rashi: "Sagittarius (Dhanu)",
        status: null,
        mother_traits: [
          "Will be religious [8]",
          "Involved in Public activity [8]",
          "Has Good Public relations [8]",
          "Suffers from cold and allied complaints [8]"
        ],
        native_traits: [
          "Has religious thoughts [8]",
          "Will desire public recognition [8]",
          "Is broad minded [8]",
          "Will find it difficult to concentrate and Focus [9]",
          "Will have a lot of changes [9]",
          "Jeev has Karma attached to mother and maybe fond of her [9]"
        ],
        combinations: [
          "Sagittarius is Mooltrikon of Ju so it is like a Ju + Mo combination [9]"
        ]
      },
      10: { // Capricorn
        rashi: "Capricorn (Makara)",
        status: null,
        mother_traits: [
          "Will have obstacles, Hurdles in life (Saturn works as speed breaker) [9]",
          "Is mufat (Thik of Thik aur galat ko galat bolegi) [9]",
          "Suffers from ill health [9]"
        ],
        native_traits: [
          "Gets obstacles, disturbance in work life [9]",
          "Mind will get disturbed [9]",
          "Takes hasty decisions in life and suffers due to this hastiness and emotional nature [9]",
          "Life may ponder over a single desire fulfilment [10]"
        ],
        combinations: [
          "Sa being dispositor carries energy of Moon which brings changes in career and unstable career [10]"
        ]
      },
      11: { // Aquarius
        rashi: "Aquarius (Kumbha)",
        status: null,
        mother_traits: [
          "Will have obstacles, Hurdles in life (Saturn works as speed breaker) [10]",
          "Is philanthropic and donates things [10]",
          "May suffer from rheumatic complaints [10]"
        ],
        native_traits: [
          "Will be of somewhat Psychic nature, Vahami [10]",
          "Has different kind of thought process [10]",
          "Is engaged in secret mental manipulations (Khayali pulav) [10]",
          "Has intuition powers and can do well as a psychologist, occultist [11]",
          "May send the native to foreign land [11]"
        ],
        combinations: [
          "Aquarius is Mooltrikon rashi of Sa so it is a combination of Sa + Mo + Ra [11]"
        ]
      },
      12: { // Pisces
        rashi: "Pisces (Meena)",
        status: null,
        mother_traits: [
          "Is religious, pious [11]"
        ],
        native_traits: [
          "Will be more spiritual and a step ahead then being in Sagittarius [11]",
          "Has shining eyes [11]",
          "Is fickle minded ",
          "Helps others in times of need ",
          "Is imaginative and romantic ",
          "Will encounter changes in life ",
          "Mo + Me in Pisces can make a good writer "
        ],
        combinations: [
          "Moon’s energy is carried by Jupiter as Jupiter is dispositor "
        ]
      }
    };

    function getMoonRashiPredictions(horoscope) {
      // 1. Validate the input object structure
      if (!horoscope || !horoscope.Moon || typeof horoscope.Moon.sign !== 'number') {
        return {
          error: "Invalid horoscope object: Moon sign is required.",
          citation: "N/A"
        };
      }

      const moonSignIndex = horoscope.Moon.sign;

      // 2. Check if the sign index is valid (1-12)
      if (moonSignIndex < 1 || moonSignIndex > 12) {
        return {
          error: `Sign index ${moonSignIndex} is out of the valid range (1-12).`,
          citation: "N/A"
        };
      }

      // 3. Retrieve predictions
      const predictions = moonRashiPredictions[moonSignIndex];

      // 4. Determine the Moon's general karakas (characteristics)
      const moonKarakas = [
        "Mother", "Elder sister", "Woman", "Milk", "Fickle", "Changing",
        "Smooth", "vitreous", "Restaurants", "eatables", "Hotels",
        "Foreign Land", "Psychology", "Soft", "Travels", "Changes",
        "Mind", "Water", "Blames"
      ];
      const moonRelationships = {
        friends: ["Jupiter", "Sun"],
        moderate: ["Mars", "Mercury"],
        enemy: ["Saturn", "Venus", "Rahu"]
      };

      // 5. Structure the comprehensive output
      const output = {
        planet: "Moon",
        rashi: predictions.rashi,
        general_karakas: moonKarakas.map(k => k + " [13]"),
        general_relationships: {
          friends: moonRelationships.friends.map(p => p + " [12]"),
          moderate: moonRelationships.moderate.map(p => p + " [12]"),
          enemy: moonRelationships.enemy.map(p => p + " [12]")
        },
        rashi_specific_predictions: {
          status: predictions.status ? predictions.status + " [2, 7, 12]" : "Neutral",
          mother: predictions.mother_traits,
          native_mind_and_traits: predictions.native_traits,
          combinations: predictions.combinations
        }
      };

      // Include aspect details
      output.aspects = {
        aspect_house: "7th house from its position [12]",
        nature: "Mild influence [14]",
        effect: "Increases emotional sensitivity in relationships [14]",
        classical_text_interpretation: "The Moon’s aspect nourishes the aspected house (Phal Deepika) [14]"
      };

      var outputHTML = `
      <h3>Moon in ${output.rashi}</h3>
      <h4>General Karakas:</h4>
      <ul>
        ${output.general_karakas.map(k => `<li>${k}</li>`).join('')}
      </ul>
      <h4>General Relationships:</h4>
      <ul>
        <li>Friends: ${output.general_relationships.friends.join(', ')}</li>
        <li>Moderate: ${output.general_relationships.moderate.join(', ')}</li>
        <li>Enemy: ${output.general_relationships.enemy.join(', ')}</li>
      </ul>
      <h4>Aspects:</h4>
      <ul>
        <li>Aspect House: ${output.aspects.aspect_house}</li>
        <li>Nature: ${output.aspects.nature}</li>
        <li>Effect: ${output.aspects.effect}</li>
        <li>Classical Text Interpretation: ${output.aspects.classical_text_interpretation}</li>
      </ul>
      <h4>Rashi Specific Predictions:</h4>
      <ul>
        <li>Status: ${output.rashi_specific_predictions.status}</li>
        <li>Mother Traits:
          <ul>
            ${output.rashi_specific_predictions.mother.map(t => `<li>${t}</li>`).join('')}
          </ul>
        </li>
        <li>Native Mind and Traits:
          <ul>
            ${output.rashi_specific_predictions.native_mind_and_traits.map(t => `<li>${t}</li>`).join('')}
          </ul>
        </li>
        <li>Combinations:
          <ul>
            ${output.rashi_specific_predictions.combinations.length > 0 ? output.rashi_specific_predictions.combinations.map(c => `<li>${c}</li>`).join('') : '<li>None</li>'}
          </ul>
        </li>
      </ul>
      <p><em></em></p>
    `;
      output.output_summary =
    [
        `Rashi: ${output.rashi}`,
        `Status: ${output.rashi_specific_predictions.status}`,
        `Mother Traits: ${output.rashi_specific_predictions.mother.join('; ')}`,
        `Native Mind and Traits: ${output.rashi_specific_predictions.native_mind_and_traits.join('; ')}`,
        `Combinations: ${output.rashi_specific_predictions.combinations.join('; ') || 'None'}`
      ];

      createCard('Moon in Rashi', outputHTML, 'html');
      return output;
    }

    /**
 * Maps Rashi numbers (1=Aries, 12=Pisces) to their names for better output readability.
 */
const RASHI_MAP = {
    1: "Aries", 2: "Taurus", 3: "Gemini", 4: "Cancer", 5: "Leo", 6: "Virgo",
    7: "Libra", 8: "Scorpio", 9: "Sagittarius", 10: "Capricorn", 11: "Aquarius", 12: "Pisces"
};

/**
 * Astrological predictions for Saturn placed in relative houses from Jupiter.
 * Source: [1] through [2].
 */
const SATURN_FROM_JUPITER_PREDICTIONS = {
    1: { // Saturn in 1st House from Jupiter [1]
        traits: [
            "Native is Lazy",
            "Will face struggle",
            "Person is pious and has good thoughts",
            "Tends to procrastinate things",
            "Feels depressive often",
            "Prosperity to father",
            "Falls in bad habits and later on will try to recover with Guilt"
        ],
        special_note: "If Jupiter is ahead of Saturn (in Rashi number), the person has Maha Bhagya Yoga. Profession is inspired by Jupiter. They will develop other people by teaching and preaching them.",
        professions: ["Managerial", "Teaching", "Consulting", "Own work"]
    },
    2: { // Saturn in 2nd House from Jupiter [3]
        traits: [
            "Has a rough and sharp tongue",
            "Earns and wastes a lot of money",
            "Lacks domestic happiness, despite having everything",
            "Late marriage, but they try to select their own partners",
            "Starts earning at very early age"
        ],
        special_note: "These people take low risk investments or very long term investments.",
        professions: ["Related to finances", "Liquor", "Medicine", "Food", "Money lender", "Investment"]
    },
    3: { // Saturn in 3rd House from Jupiter [3, 4]
        traits: [
            "Very bold and high-risk taking personality",
            "Will change Jobs frequently, typically from 24-36 years of age",
            "Troubles from siblings",
            "Can bring trouble in the form of court cases or fights with neighbors and siblings"
        ],
        special_note: "Signifies loss of Job or frequent losses in business. Native will incur losses from gambling, share market, or trading.",
        professions: ["Communication related", "Mass media", "Marketing", "Tourism", "Packaging and shipping", "Railways", "Hands and Shoulders use like gym trainer and writer", "Singing", "Dancing", "Painting"]
    },
    4: { // Saturn in 4th House from Jupiter [5]
        traits: [
            "Hindrances/Obstacles in education (denotes technical nature of education)",
            "Lacks *Ghar ka sukh* (domestic happiness)",
            "Shows hardships in life of Mother",
            "The person is born in an old and less ventilated house",
            "Native may settle away from family"
        ],
        professions: ["Teaching", "Land/property", "Construction", "Garments", "Automobiles", "Home based office"]
    },
    5: { // Saturn in 5th House from Jupiter [5, 6]
        traits: [
            "Delay in childbirth (After 28, 30)",
            "Signifies danger to first child (Many times the first child will be female)",
            "Troubles in life 3-4 years after birth of 1st child",
            "May give bad habits like gambling, prostitution, alcohol, cigarette",
            "People will have spinal cord related issues"
        ],
        professions: ["Government Job", "Politics", "Mentor", "Sportsperson", "MBA", "CEO"]
    },
    6: { // Saturn in 6th House from Jupiter [6, 7]
        traits: [
            "Signifies prolonged sickness (liver, pancreas, large intestine)",
            "Possibility of animal bite",
            "Troubles through servants and employees",
            "Long life but prolonged diseases",
            "Open enemy is powerful",
            "Native’s siblings will incur lot of losses in their life"
        ],
        professions: ["Law", "Medicine", "Doctor", "Auditing", "Analysis", "Competitive exams"]
    },
    7: { // Saturn in 7th House from Jupiter [7, 8]
        traits: [
            "Becomes popular, or receives a lot of public interaction in their profession",
            "Will have bad company for friendships",
            "Would not have the greatest of childhood",
            "May have stone in kidneys",
            "Problem in having 2nd child",
            "Day-to-day Life is stressful and burdensome"
        ],
        professions: ["Teachers", "Preachers", "Bankers", "Lawyers", "Consultants", "Managers"]
    },
    8: { // Saturn in 8th House from Jupiter [8, 9]
        traits: [
            "Will make person interested in occult sciences, insurance, research, surgeon",
            "Gives good longevity but gives long term sickness",
            "Brother of native will have prolonged sickness",
            "Has harsh tongue and may marry against tradition",
            "Children can stay away from home",
            "Problems pertaining to sexual organs and urinary tract issues"
        ],
        professions: ["Occult sciences", "Insurance", "Research", "Surgeon"]
    },
    9: { // Saturn in 9th House from Jupiter [9, 10]
        traits: [
            "Bad friends of Native",
            "Problems in Sibling’s life",
            "Native will have to undergo long distance travels for profession (may even go to foreign lands)",
            "He will fall sick in long distance travels",
            "Native may take a spiritual journey at the age of 39",
            "Awards and honors in foreign land",
            "2nd childbirth by delay or problems in having second child",
            "Shows debtors or lot of enmities to father"
        ],
        professions: ["Teaching", "Preaching", "Travel", "Higher education", "Spiritual career"]
    },
    10: { // Saturn in 10th House from Jupiter [10]
        traits: [
            "Problems to both parents at the time of Birth of native",
            "Father will have lot of problems and health issues",
            "Will do well in profession and will have authority",
            "People would work under native",
            "Native will have troubles related to knee joint"
        ],
        professions: ["Civil services", "Neurology", "Govt. jobs", "MBA", "Top rank in any company"]
    },
    11: { // Saturn in 11th House from Jupiter [11]
        traits: [
            "Bad friends",
            "Coming and going of gains (fluctuating)",
            "Sadness from desires",
            "Lot of troubles in early age (up to 28/29 years of Age)",
            "Gambling, affairs, bad people, drinking habits",
            "Delays native's childbirth",
            "Would have interest in occult"
        ],
        professions: ["Research", "Innovation", "IT", "AI", "Public jobs like Bankers", "Relationship managers", "Communication related"]
    },
    12: { // Saturn in 12th House from Jupiter [2, 11]
        traits: [
            "Shows native can have job or profession in foreign land, or do business with foreigners",
            "Job in watery place",
            "Changeable job",
            "Afflicted Saturn here can cause hospitalization and imprisonment",
            "Strong/powerful secret enemy"
        ],
        professions: ["Spiritual field", "Navy", "Water", "Aviation", "Foreign", "MNC"]
    }
};

/**
 * Calculates the house placement of Saturn relative to Jupiter and returns the prediction.
 * @param {object} horoscope - The chart data containing Saturn and Jupiter signs.
 * @returns {object} The specific prediction for Saturn's relative placement.
 */
function getSaturnFromJupiterPredictions(horoscope) {
    if (!horoscope || !horoscope.Saturn || !horoscope.Jupiter) {
        return {
            error: "Invalid horoscope object: Saturn and Jupiter data are required.",
            citation: "N/A"
        };
    }

    const saturnSign = horoscope.Saturn.sign;
    const jupiterSign = horoscope.Jupiter.sign;

    // Calculate the house number of Saturn from Jupiter (1 to 12)
    // Formula: (Saturn_Sign - Jupiter_Sign + 12) % 12 + 1
    const houseFromJupiter = (saturnSign - jupiterSign + 12) % 12 + 1;

    const predictionData = SATURN_FROM_JUPITER_PREDICTIONS[houseFromJupiter];

    if (!predictionData) {
        return {
            error: "Calculation error: Relative house position is out of range.",
            citation: "N/A"
        };
    }

    // Include General Saturn Karakas for context [12]
    const saturnKarakas = [
        "Action", "Karma", "Duty", "Profession", "Bad period", "Death", "Delay",
        "Desire to do", "Obstacles", "Village headman", "Livelihood", "Elder brother", "Servants"
    ];

    createCard('Saturn from Jupiter', `
        <h3>Saturn in ${RASHI_MAP[saturnSign]}, Jupiter in ${RASHI_MAP[jupiterSign]}</h3>
        <h4>House from Jupiter: ${houseFromJupiter}</h4>
        <h4>Traits:</h4>
        <ul>
            ${predictionData.traits.map(t => `<li>${t}</li>`).join('')}
        </ul>
        <h4>Professions:</h4>
        <ul>
            ${predictionData.professions.map(p => `<li>${p}</li>`).join('')}
        </ul>
        ${predictionData.special_note ? `<h4>Special Note:</h4><p>${predictionData.special_note}</p>` : ''}
        <h4>General Saturn Karakas:</h4>
        <ul>
            ${saturnKarakas.map(k => `<li>${k} [12]</li>`).join('')}
        </ul>
        <p><em>Astrological principles source: Bhrigu Nandi Nadi (Class 21, Saturn in Different Houses from Jupiter) [1-12]</em></p>
    `, 'html');
    return {
        planet_of_study: "Saturn",
        relative_planet: "Jupiter",
        saturn_sign: RASHI_MAP[saturnSign],
        jupiter_sign: RASHI_MAP[jupiterSign],
        house_from_jupiter: houseFromJupiter,
        general_saturn_karakas: saturnKarakas,
        predictions: {
            character_and_family: predictionData.traits,
            career_fields: predictionData.professions,
            notes: predictionData.special_note || null
        },
        astrological_principles_source: "Bhrigu Nandi Nadi (Class 21, Saturn in Different Houses from Jupiter) [1-12]"
    };
}
    // Attach save and load UI components
    window.addEventListener('DOMContentLoaded', () => {
      const container = document.createElement('div');
      container.innerHTML = `
    <input type="text" id="horoscope-name" placeholder="Enter name to save horoscope" />
    <button onclick="const name = document.getElementById('horoscope-name').value.trim(); if(name){ saveHoroscopeWithName(name, nativeHoroscope); }">Save Horoscope</button>
    <select id="horoscope-select" onchange="if(this.value) loadHoroscopeByName(this.value)"></select>
  `;
      document.body.insertBefore(container, document.getElementById('inputForm'));
      updateHoroscopeDropdown();
    });
  </script>
</body>

</html>