<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="BNN_Comb.js"></script>
  <script src="transit.js"></script>
  <script src="significator.js"></script>

  <title>BNN Trine Visualizer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }

    h1 {
      text-align: center;
    }

    .planet-input {
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    label {
      width: 110px;
    }

    select,
    input {
      padding: 5px;
    }

    #results {
      margin-top: 20px;
      padding: 10px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .chart {
      margin-top: 30px;
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
      justify-content: space-around;
    }

    .trine-chart {
      width: 20%;
      flex-grow: 0;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 10px;
      background: #fff;
    }

    .trine-chart h3 {
      margin-bottom: 10px;
    }

    .trine-chart ul {
      list-style: none;
      padding: 0;
    }

    .trine-chart li {
      margin: 5px 0;
    }

    .conj-result {
      margin-top: 10px;
      padding: 8px;
      border-left: 4px solid #0077cc;
      background: #f0f8ff;
    }
  </style>
</head>

<body>
  <h1>BNN Trine & Aspect Visualizer</h1><br><br><br>
  <div id="inputForm"></div>
  <!-- Diamond Chart -->
  <div id="diamond-chart" style="margin-top: -424px;position: absolute;margin-left: 800px;"></div>
  <button onclick="analyzeHoroscope()">Analyze</button>
  <!-- Jupiter Rotation Age Selector -->
  <div class="planet-input">
    <label>Jupiter Minor Progression</label>

    <label>Current Age</label>
    <select id="age-select">

    </select>
    <button onclick="calculateJupiterProgression()">Get Jupiters House</button>
    <button onclick="getJupiterMajorProgression()">Jupiters Major Progression</button>

  </div>
  <!-- Conjunction checker -->
  <div class="planet-input" style="margin-top:20px">
    <label>Check Conjunction</label>
    <select id="conj-p1">
      <option value="">--Select Planet 1--</option>
    </select>
    <select id="conj-p2">
      <option value="">--Select Planet 2--</option>
    </select>
    <button onclick="checkConjunction()">Check</button>
  </div>
  <div class="planet-input" style="margin-top:20px">
    <label>Jupiter Transit Sign</label>
    <select id="transit-jupiter-sign">
    </select>
    <label>Saturn Transit Sign</label>
    <select id="transit-saturn-sign">
    </select>
    <button onclick="analyzeTransits()">Analyze Transit Effects</button>
  </div>
  <div id="results"></div>

  <script>
    /* ---------- CONFIG ---------- */
    const signs = [
      "Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo",
      "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"
    ];

    const planets = [
      "Sun", "Moon", "Mars", "Mercury", "Venus", "Jupiter", "Saturn", "Rahu", "Ketu"
    ];

    document.getElementById('age-select').innerHTML = `${[...Array(100).keys()].map(i => `<option value="${i + 1}">${i + 1} years</option>`).join('')}`;

    document.getElementById('transit-jupiter-sign').innerHTML = `${signs.map((s, i) => `<option value="${i + 1}">${s}</option>`).join('')}`;

    document.getElementById('transit-saturn-sign').innerHTML = `${signs.map((s, i) => `<option value="${i + 1}">${s}</option>`).join('')}`;

    /* ---------- LOAD COMBINATION DATA ---------- 
    let combinationData = [];
    fetch('BNN_Comb.json')
      .then(res => res.json())
      .then(data => combinationData = data)
      .catch(() => alert('Failed to load combination data. Predictions may be unavailable.'));
  */
    /* ---------- BUILD INPUT FORM ---------- */
    const formDiv = document.getElementById("inputForm");
    planets.forEach(planet => {
      const div = document.createElement("div");
      div.className = "planet-input";
      div.innerHTML = `
      <label>${planet}</label>
      <select id="${planet}-sign">
        ${signs.map((s, i) => `<option value="${i + 1}">${s} - ${i + 1}</option>`).join('')}
      </select>
      <input id="${planet}-deg" type="number" min="0" max="29.99" step="0.01" placeholder="Degree (0-29.99)" />
	  <select id="${planet}-house">
        ${[...Array(12).keys()].map(i => `<option value="${i + 1}">${i + 1} House</option>`).join('')}
      </select>
      <input id="${planet}-retrograde" type="checkbox" />
    `;
      formDiv.appendChild(div);
    });

    /* Populate conjunction dropdowns */
    const conjP1Sel = document.getElementById('conj-p1');
    const conjP2Sel = document.getElementById('conj-p2');
    planets.forEach(p => {
      const opt1 = new Option(p, p);
      const opt2 = new Option(p, p);
      conjP1Sel.add(opt1);
      conjP2Sel.add(opt2);
    });
    var nativeHoroscope = {};
    /* ---------- ANALYZE HOROSCOPE ---------- */
    function analyzeHoroscope() {
      const horoscope = {};
      planets.forEach(p => {
        const sign = parseInt(document.getElementById(`${p}-sign`).value);
        const degree = parseFloat(document.getElementById(`${p}-deg`).value);
        const house = parseInt(document.getElementById(`${p}-house`).value);
        const retrograde = document.getElementById(`${p}-retrograde`)?.checked || false;
        if (!isNaN(degree)) {
          horoscope[p] = { sign, degree, house, retrograde };
        }
      });
      nativeHoroscope = horoscope;
      console.log('Native Horoscope:', horoscope);
      const result = getTrineGroupsWithBNNAspects(horoscope);
      const parivartans = detectParivartan(horoscope);
      renderResults(result, parivartans);
      renderDiamondChart(horoscope);
      getMarriageOutcomeForFemale(horoscope);
      getMarriageOutcomeForMale(horoscope);
      interpretAllConjunctions(horoscope, property);
      showSignLordPlacements(horoscope);
      showProfessionFromHoroscope(horoscope);
      getWorkEnvironmentFromHoroscope(horoscope);
    }

    /* ---------- CORE LOGIC: TRINES, ASPECTS & PREDICTIONS ---------- */
    function getTrineGroupsWithBNNAspects(horoscope) {
      const trineMap = {
        '1': [1, 5, 9],
        '2': [2, 6, 10],
        '3': [3, 7, 11],
        '4': [4, 8, 12]
      };

      const signToTrineKey = {};
      Object.entries(trineMap).forEach(([k, arr]) => arr.forEach(s => signToTrineKey[s] = k));

      const trineGroups = { '1': [], '2': [], '3': [], '4': [] };

      const allPlanets = [];

      for (const [planet, { sign, degree }] of Object.entries(horoscope)) {
        const key = signToTrineKey[sign];
        const absDegree = (sign - 1) * 30 + degree;
        const data = { planet, sign, degree, absDegree };
        allPlanets.push(data);
        trineGroups[key].push(data);
      }

      for (const k in trineGroups) {
        trineGroups[k].sort((a, b) => a.absDegree - b.absDegree);
      }

      const result = {};
      for (const k in trineGroups) {
        const group = [...trineGroups[k]];
        const conjunctions = [];
        const aspects = [];
        const predictions = [];

        // Include planets in 2nd, 12th, and 7th from each trine member
        /* */
        const signsInGroup = new Set(trineMap[k]);
        group.forEach(({ sign, absDegree }) => {
          const second = (sign % 12) + 1;
          const twelfth = ((sign + 10 - 1) % 12) + 1;
          const seventh = ((sign + 6 - 1) % 12) + 1;

          const nearbySigns = [second, twelfth, seventh];
          allPlanets.forEach(p => {
            if (nearbySigns.includes(p.sign) && !signsInGroup.has(p.sign)) {
              group.push(p);
            }
          });
        });

        // Deduplicate and sort again
        const uniqueMap = {};
        group.forEach(p => uniqueMap[p.planet] = p);
        const uniqueGroup = Object.values(uniqueMap).sort((a, b) => a.absDegree - b.absDegree);
        /* Old Logic
            for (let i = 0; i < uniqueGroup.length; i++) {
              for (let j = i + 1; j < uniqueGroup.length; j++) {
                const p1 = uniqueGroup[i].planet;
                const p2 = uniqueGroup[j].planet;
                if (uniqueGroup[i].sign === uniqueGroup[j].sign && Math.abs(uniqueGroup[i].degree - uniqueGroup[j].degree) <= 3) {
                  conjunctions.push({ pair: [p1, p2], sign: uniqueGroup[i].sign, degrees: [uniqueGroup[i].degree, uniqueGroup[j].degree] });
                }
                aspects.push({ from: p1, to: p2, note: `${p1} influences ${p2}` });
      
                const combo = findCombination(p1, p2);
                //if (combo) predictions.push(...combo.predictions);
            if (combo) combo.predictions.forEach(pr => predictions.push(`${p1} & ${p2}: ${pr}`));
      
              }
            }
          */
        for (let i = 0; i < uniqueGroup.length; i++) {
          for (let j = i + 1; j < uniqueGroup.length; j++) {
            const g1 = uniqueGroup[i];
            const g2 = uniqueGroup[j];
            const p1 = g1.planet;
            const p2 = g2.planet;

            if (g1.sign === g2.sign) {
              conjunctions.push({ pair: [p1, p2], sign: g1.sign, degrees: [g1.degree, g2.degree] });
            }
            console.log("Checking if ", g1.degree, "<", g2.degree);
            if (g1.degree < g2.degree) {
              aspects.push({ from: p1, to: p2, note: `${p1} influences ${p2}` });
              const combo = findCombination(p1, p2);
              if (combo) {
                const key = `${p1} & ${p2}`;
                combo.predictions.forEach(pr => predictions.push(`${p1} & ${p2}: ${pr}`));
                //if (!predictions[key]) predictions[key] = [];
                //combo.predictions.forEach(pr => predictions[key].push(pr));
              }
            }
          }
        }

        result[k] = {
          trineSigns: trineMap[k],
          planets: uniqueGroup,
          conjunctions,
          aspects,
          predictions: [...new Set(predictions)]
        };
      }

      return result;
    }

    /* Utility to find combination irrespective of order */
    function findCombination(p1, p2) {
      return combinationData.find(c =>
        (c.planets[0] === p1 && c.planets[1] === p2) ||
        (c.planets[0] === p2 && c.planets[1] === p1)
      );
    }

    /* ---------- RENDER RESULTS ---------- */
    function renderResults(data, parivartans) {
      const div = document.getElementById("results");
      div.innerHTML = `<h2>Results</h2>`;
      const chart = document.createElement("div");
      chart.className = "chart";

      for (const k in data) {
        const g = data[k];
        const container = document.createElement("div");
        container.className = "trine-chart";
        container.innerHTML = `
        <h3>Trine: ${g.trineSigns.join("-")}</h3>
        <strong>Planets:</strong>
        <ul>${g.planets.map(p => `<li>${p.planet}: Sign ${p.sign}, ${p.degree.toFixed(2)}°</li>`).join('')}</ul>
        ${g.conjunctions.length ? `<strong>Conjunctions:</strong><ul>${g.conjunctions.map(c => `<li>${c.pair.join(' & ')} in Sign ${c.sign}</li>`).join('')}</ul>` : ''}
        ${g.aspects.length ? `<strong>Aspects:</strong><ul>${g.aspects.map(a => `<li>${a.note}</li>`).join('')}</ul>` : ''}
        ${g.predictions.length ? `<strong>Predictions:</strong><ul>${g.predictions.map(p => `<li>${p}</li>`).join('')}</ul>` : ''}
      `;
        chart.appendChild(container);
      }
      div.appendChild(chart);
      if (parivartans.length) {
        const pDiv = document.createElement('div');
        pDiv.innerHTML = `<h3>Parivartan Yogas Detected:</h3><ul>${parivartans.map(p => `<li><strong>${p}</strong></li>`).join('')}</ul>`;
        div.appendChild(pDiv);
      }
      else {
        const pDiv = document.createElement('div');
        pDiv.innerHTML = `<h3>No Parivartan Yogas Detected:</h3>`;
        div.appendChild(pDiv);
      }
    }

    /* ---------- CONJUNCTION CHECKER ---------- */
    function checkConjunction() {
      const p1 = document.getElementById("conj-p1").value;
      const p2 = document.getElementById("conj-p2").value;
      if (!p1 || !p2 || p1 === p2) {
        alert("Please select two different planets.");
        return;
      }

      const d1 = parseFloat(document.getElementById(`${p1}-deg`).value);
      const d2 = parseFloat(document.getElementById(`${p2}-deg`).value);
      const s1 = parseInt(document.getElementById(`${p1}-sign`).value);
      const s2 = parseInt(document.getElementById(`${p2}-sign`).value);

      if (isNaN(d1) || isNaN(d2)) {
        alert("Please enter valid degrees for both planets.");
        return;
      }

      const resultDiv = document.getElementById("results");
      // Find predictions for this pair
      const combo = findCombination(p1, p2);
      let predHTML = '';
      if (combo && combo.predictions && combo.predictions.length) {
        predHTML = '<strong>Predictions:</strong><ul>' + combo.predictions.map(pr => `<li>${pr}</li>`).join('') + '</ul>';
        areConjunct = true;
      } else {
        predHTML = '<p><em>No specific predictions found for this combination.</em></p>';
        areConjunct = false;
      }

      const html = `
      <div class="conj-result">
        <p><strong>${p1} &amp; ${p2}</strong> ${areConjunct ? 'are' : 'are not'} in conjunction.</p>
        ${predHTML}
      </div>`;

      document.getElementById('results').insertAdjacentHTML('afterbegin', html);
    }

    function calculateJupiterProgression() {
      const jupiterSign = parseInt(document.getElementById('Jupiter-sign').value);
      const jupiterHouse = parseInt(document.getElementById('Jupiter-house').value);
      const age = parseInt(document.getElementById('age-select').value);

      if (isNaN(jupiterSign)) {
        alert('Please select Jupiter sign');
        return;
      }
      console.log();
      const totalMonths = age * 12;
      //const progressedSign  = (jupiterSign  + age) < 13 ? jupiterSign  + age - 1 : ((jupiterSign  - 1 + age) % 12) + 1;
      //const progressedHouse = (jupiterHouse + age) < 13 ? jupiterHouse + age - 1 : ((jupiterHouse - 1 + age) % 12) + 1;
      const progressedSign = ((jupiterSign - 1 + age) % 12) == 0 ? jupiterSign : ((jupiterSign - 1 + age) % 12);
      const progressedHouse = ((jupiterHouse - 1 + age) % 12);

      const result = `Age ${age} Jupiter is currently in House ${jupiterHouse} -> ${progressedHouse} Sign ${jupiterSign} -> ${progressedSign} (Sign: ${signs[progressedSign - 1]})`;

      const div = document.getElementById("results");
      div.insertAdjacentHTML('afterbegin', `<p><strong>${result}</strong></p>`);
    }
    function detectParivartan(horoscope) {
      // Basic sign lordship map (assuming traditional rulerships)
      const signLords = {
        1: "Mars", 2: "Venus", 3: "Mercury", 4: "Moon", 5: "Sun", 6: "Mercury",
        7: "Venus", 8: "Mars", 9: "Jupiter", 10: "Saturn", 11: "Saturn", 12: "Jupiter"
      };

      const placements = {};
      for (const [planet, { sign }] of Object.entries(horoscope)) {
        if (!placements[sign]) placements[sign] = [];
        placements[sign].push(planet);
      }

      const parivartans = [];
      for (const [planet, { sign }] of Object.entries(horoscope)) {
        const lordOfThisSign = signLords[sign];
        const signOfThisPlanet = sign;
        const signOfLord = Object.entries(horoscope).find(([p, v]) => p === lordOfThisSign)?.[1]?.sign;
        const lordOfThatSign = signLords[signOfLord];

        if (planet === lordOfThatSign && planet !== lordOfThisSign) {
          const pair = [planet, lordOfThisSign].sort().join(" & ");
          if (!parivartans.find(p => p === pair)) {
            parivartans.push(pair);
          }
        }
      }

      return parivartans;
    }


    function renderDiamondChart(horoscope) {
      const housePlanets = Array.from({ length: 12 }, () => []);
      const fixedHouse = {};//Array.from({ length: 12 }, () => []);

      const ascendant = parseInt(document.getElementById('Ascendant-sign')?.value || '1');
      var idx = 1;
      for (const [planet, { sign, degree, house }] of Object.entries(horoscope)) {
        console.log('Redering Diamond Chart');
        console.log(sign, degree, house);
        housePlanets[sign - 1].push(`${planet} (${degree.toFixed(1)}°)`);

        if (fixedHouse.hasOwnProperty(house)) {
          fixedHouse[house].push(`${planet} (${degree.toFixed(1)}°) ${sign}`);
        }
        else {
          fixedHouse[house] = [];
          fixedHouse[house].push(`${planet} (${degree.toFixed(1)}°) ${sign}`);
        }
        idx++;
      }

      const layout = Array.from({ length: 12 }, (_, i) => ((ascendant + i - 1) % 12) + 1);
      const container = document.getElementById('diamond-chart');
      container.innerHTML = '<h2>Diamond Horoscope Chart</h2><img src="https://raw.githubusercontent.com/ShreeAura-Astrology/jwtPY/main/New-Kundli.png" width="700px" height="100%"/>';

      const diamond = document.createElement('div');
      diamond.style.position = 'relative';
      diamond.style.width = '694px';
      diamond.style.height = '482px';
      diamond.style.marginTop = '-498px';
      // diamond.style.background-image  = 'url(https://raw.githubusercontent.com/ShreeAura-Astrology/jwtPY/main/New-Kundli.png)';
      // diamond.style.background-repeat = 'no-repeat';

      const boxPositions = [
        { top: '23%', left: '45%' }, // 1
        { top: '10%', left: '19%' }, // 2
        { top: '18%', left: '3%' }, // 3
        { top: '41%', left: '18%' }, // 4
        { top: '69%', left: '1%' }, // 5
        { top: '90%', left: '16%' }, // 6
        { top: '70%', left: '45%' }, // 7
        { top: '90%', left: '70%' }, // 8
        { top: '70%', left: '88%' }, // 9 (center)
        { top: '40%', left: '70%' }, // 10
        { top: '14%', left: '87%' }, // 11
        { top: '3%', left: '70%' }  // 12
      ];

      console.log(layout);
      layout.forEach((sign, i) => {
        const box = document.createElement('div');
        const planets = housePlanets[sign - 1].join('<br>');
        const allP = fixedHouse.hasOwnProperty(sign) ? fixedHouse[sign].join('<br>') : `${sign}<br>`;
        box.innerHTML = `<strong>${allP}</strong>`;
        //box.innerHTML = `<strong>${allP}</strong><strong><br>${signs[sign - 1]}</strong><br>${planets}`;

        box.style.position = 'absolute';
        //box.style.width = '80px';
        //box.style.height = '60px';
        box.style.border = '1px solid #999';
        box.style.fontSize = '11px';
        box.style.background = (sign === ascendant) ? '#ffffcc' : '#fff';
        box.style.textAlign = 'center';
        box.style.padding = '4px';
        box.style.boxSizing = 'border-box';
        box.style.top = boxPositions[i].top;
        box.style.left = boxPositions[i].left;
        diamond.appendChild(box);
      });

      container.appendChild(diamond);
    }
    function getJupiterMajorProgression() {
      const jupiterSign = parseInt(document.getElementById('Jupiter-sign').value);
      const jupiterHouse = parseInt(document.getElementById('Jupiter-house').value);
      const age = parseInt(document.getElementById('age-select').value);
      var outputResult = performJupiterProgression(nativeHoroscope, age)
      const result = `Age ${outputResult.age} Jupiter progressed to focusHouse from current sign ${outputResult.focusHouse} -> ${outputResult.progressedHouse} <br>Planets ${outputResult.keyPlanets.join(' , ')}`;

      const div = document.getElementById("results");
      div.insertAdjacentHTML('afterbegin', `<p><strong>${result}</strong></p>`);
    }
    function performJupiterProgression(horoscope, age) {
      const jupiterSign = horoscope['Jupiter']?.sign;
      if (!jupiterSign || !age) return null;

      const houseFocus = Math.floor(age / 12) + 1;
      const houseFromJupiter = ((jupiterSign - 1 + (houseFocus - 1)) % 12) + 1;

      const signLords = {
        1: 'Mars', 2: 'Venus', 3: 'Mercury', 4: 'Moon', 5: 'Sun', 6: 'Mercury',
        7: 'Venus', 8: 'Mars', 9: 'Jupiter', 10: 'Saturn', 11: 'Saturn', 12: 'Jupiter'
      };

      const planetsInHouse = Object.entries(horoscope)
        .filter(([_, val]) => val.sign === houseFromJupiter)
        .map(([p]) => p);

      const conjunctions = planetsInHouse.slice();

      const trineSigns = [1, 5, 9, 2, 6, 10, 3, 7, 11, 4, 8, 12];
      const trines = trineSigns.filter(s => (Math.abs(s - houseFromJupiter) % 4 === 0))
        .map(s => Object.entries(horoscope).filter(([_, val]) => val.sign === s).map(([p]) => p)).flat();

      const seventhHouse = ((houseFromJupiter + 6 - 1) % 12) + 1;
      const seventh = Object.entries(horoscope)
        .filter(([_, val]) => val.sign === seventhHouse)
        .map(([p]) => p);
      console.log('houseFocus:' + houseFocus + ' houseFromJupiter:' + houseFromJupiter + ' Dispositor Sign:' + (jupiterSign + houseFromJupiter));
      var signOfJupiterProgression = (jupiterSign - 1 + houseFocus) % 12;
      const jupiterDispositor = signLords[signOfJupiterProgression];
      const dispositorsHouse = horoscope[jupiterDispositor]?.sign;
      const conjunctionWithDispositor = Object.entries(horoscope)
        .filter(([p, val]) => val.sign === dispositorsHouse && p !== jupiterDispositor)
        .map(([p]) => p);

      const seventhFromDispositor = ((dispositorsHouse + 6 - 1) % 12) + 1;
      const seventhFromDisp = Object.entries(horoscope)
        .filter(([_, val]) => val.sign === seventhFromDispositor)
        .map(([p]) => p);

      const resultSet = new Set([
        ...planetsInHouse,
        ...conjunctions,
        ...trines,
        ...seventh,
        ...conjunctionWithDispositor,
        ...seventhFromDisp,
        ...jupiterDispositor
      ]);
      console.log(`jupiterDispositor:` + jupiterDispositor);
      console.log('planetsInHouse', planetsInHouse,
        '\nconjunctions', conjunctions,
        '\ntrines', trines,
        '\nseventh', seventh,
        '\nconjunctionWithDispositor', conjunctionWithDispositor,
        '\nseventhFromDisp', seventhFromDisp);
      return {
        age,
        focusHouse: houseFocus,
        progressedHouse: houseFromJupiter,
        keyPlanets: Array.from(resultSet)
      };
    }

    function analyzeTransits() {
      const jSign = parseInt(document.getElementById('transit-jupiter-sign').value);
      const sSign = parseInt(document.getElementById('transit-saturn-sign').value);

      const horoscope = {};
      planets.forEach(p => {
        const sign = parseInt(document.getElementById(`${p}-sign`).value);
        const degree = parseFloat(document.getElementById(`${p}-deg`).value);
        if (!isNaN(sign) && !isNaN(degree)) {
          horoscope[p] = { sign, degree };
        }
      });

      const transits = [];
      const planetInTransitAspects = { "Jupiter": [], "Saturn": [] };
      for (const [planet, { sign }] of Object.entries(horoscope)) {
        const aspects = [sign];

        if ((Math.abs(jSign - sign) % 12) === 6 || (Math.abs(jSign - sign) % 12) === 8 || (Math.abs(jSign - sign) % 12) === 2 || (Math.abs(jSign - sign) % 12) === 10)
          aspects.push(jSign);

        const jImpact = (sign === jSign) ? 'Strong (100%) - Same Sign' :
          ((Math.abs(jSign - sign) % 12) === 7) ? 'Very High (80%) - 7th Aspect' :
            ([1, 5, 9].includes(((sign - jSign + 12) % 12) + 1)) ? 'Moderate (50%) - Trine' :
              ([3, 11].includes(((sign - jSign + 12) % 12) + 1)) ? 'Mild (25%) -  3, 11 houses' : null;

        const sImpact = (sign === sSign) ? 'Strong (100%) - Same Sign' :
          ([3, 7, 10].includes(((sign - sSign + 12) % 12) + 1)) ? 'Very High (80%) 3rd,7th,10th Aspect' :
            ([1, 5, 9].includes(((sign - sSign + 12) % 12) + 1)) ? 'Moderate (50%) -  trinal rashis' :
              ([3, 11].includes(((sign - sSign + 12) % 12) + 1)) ? 'Mild (25%) -  3, 11 houses from transiting planets houses from transiting planets' : null;

        if (jImpact || sImpact) {
          const jText = jImpact ? `Jupiter → ${jImpact}` : '';
          const sText = sImpact ? `Saturn → ${sImpact}` : '';
          let detail = '';
          if (jImpact && jImpact.includes('Strong')) detail += 'Great opportunity for growth and dharma alignment. ';
          else if (jImpact && jImpact.includes('Very High')) detail += 'Influence on career, wisdom or expansion. ';
          else if (jImpact && jImpact.includes('Moderate')) detail += 'Spiritual or educational gains likely. ';
          if (sImpact && sImpact.includes('Strong')) detail += 'Strong karmic testing. Consolidation and discipline phase. ';
          else if (sImpact && sImpact.includes('Very High')) detail += 'Challenges to responsibility, long-term rewards. ';
          else if (sImpact && sImpact.includes('Moderate')) detail += 'Time to reflect and realign responsibilities. ';
          transits.push(`<strong>${planet}</strong>: ${jText}, ${sText}<br><em>${detail}</em>`);
          if (jImpact)
            planetInTransitAspects["Jupiter"].push(planet);
          else
            planetInTransitAspects["Saturn"].push(planet);
        }
      }
      var JupiterTransits = transit.TransitOutcomesBNN.JupiterTransits;
      var SaturnTransits = transit.TransitOutcomesBNN.SaturnTransits;
      const div = document.getElementById("results");
      const jOverPlanets = Object.entries(horoscope)
        .filter(([p, _]) => _.sign == jSign || planetInTransitAspects["Jupiter"].includes(p))
        .map(([p, v]) => {
          let msg = `Jupiter transiting over ${p} in Sign ${jSign}`;
          let effect = '';
          if (JupiterTransits && JupiterTransits[p]) {
            effect = JupiterTransits[p].map(e => `- ${e}`).join('<br>');
          } else {
            effect = 'General spiritual expansion.';
          }
          //}
          return `<li>${msg}<br><em>${effect}</em></li>`;
        }).join('');
      const sOverPlanets = Object.entries(horoscope)
        .filter(([p, _]) => _.sign == sSign || planetInTransitAspects["Saturn"].includes(p))
        .map(([p, v]) => {
          let msg = `Saturn transiting over ${p} in Sign ${sSign}`;
          let effect = '';
          if (SaturnTransits && SaturnTransits[p]) {
            effect = SaturnTransits[p].map(e => `- ${e}`).join('<br>');
          } else {
            effect = 'General karma maturation and slow progress.';
          }
          //}
          return `<li>${msg}<br><em>${effect}</em></li>`;
        }).join('');
      const html = `<h3>Transit Effects on Natal Planets</h3><ul>${transits.map(t => `<li>${t}</li>`).join('')}</ul><br><h4>Direct Transits:</h4><ul>${jOverPlanets}${sOverPlanets}</ul>`;
      div.insertAdjacentHTML('beforeend', html);
    }

    function getMarriageOutcomeForFemale(horoscope) {
      const venusSign = horoscope['Venus']?.sign;
      const marsSign = horoscope['Mars']?.sign;
      const jupiterSign = horoscope['Jupiter']?.sign;

      if (!venusSign || !marsSign || !jupiterSign) return 'Insufficient data to analyze marriage outcome.';

      const distance = (marsSign - venusSign + 12) % 12;
      let outcome = '';

      if ([1, 2, 3, 5, 7, 9, 11].includes(distance)) {
        outcome += '✅ Marriage is promised based on Mars-Venus positioning.<br>';
      } else if ([4, 6, 8, 10].includes(distance)) {
        outcome += '⚠️ Marriage obstacles indicated due to Mars in bad houses from Venus.<br>';
      }

      const getSignLord = sign => {
        const lords = {
          1: 'Mars', 2: 'Venus', 3: 'Mercury', 4: 'Moon', 5: 'Sun', 6: 'Mercury',
          7: 'Venus', 8: 'Mars', 9: 'Jupiter', 10: 'Saturn', 11: 'Saturn', 12: 'Jupiter'
        };
        return lords[sign];
      };

      const jupiterLord = getSignLord(jupiterSign);
      const jupiterLordSign = horoscope[jupiterLord]?.sign;
      const seventhFromJupiter = ((jupiterSign + 6 - 1) % 12) + 1;
      const seventhFromJLord = ((jupiterLordSign + 6 - 1) % 12) + 1;

      if ([1, 2, 3, 5, 7, 9, 11].includes((seventhFromJLord - jupiterLordSign + 12) % 12)) {
        outcome += '✅ Jupiters 7th lord is well placed — favorable for marriage.<br>';
      } else {
        outcome += '⚠️ Jupiters 7th lord is not ideally placed — possible delay or disruption.<br>';
      }

      if (((marsSign - jupiterSign + 12) % 12) === 4) {
        outcome += '✅ Jupiter aspects Mars — early marriage indicated.<br>';
      }

      // Detect possible outcomes for unmarried, separation, divorce
      const venusDegree = horoscope['Venus']?.degree || 0;
      const marsDegree = horoscope['Mars']?.degree || 0;
      const jupiterDegree = horoscope['Jupiter']?.degree || 0;

      if (((venusSign === marsSign) && Math.abs(venusDegree - marsDegree) <= 1) &&
        ((venusSign === jupiterSign) && Math.abs(venusDegree - jupiterDegree) <= 1)) {
        outcome += '⚠️ Strong Venus conjunctions with Mars and Jupiter — high chance of separation/divorce.<br>';
      }

      if (marsSign === jupiterSign && Math.abs(marsDegree - jupiterDegree) < 2) {
        outcome += '⚠️ Jupiter-Mars conjunction in same sign — may indicate emotional burnout or detachment, possible divorce.<br>';
      }

      const malefics = ['Saturn', 'Rahu', 'Ketu'];
      const maleficInfluence = malefics.filter(m => horoscope[m]?.sign === venusSign).length;

      if (maleficInfluence >= 2) {
        outcome += '⚠️ Venus heavily afflicted by malefics — high chance of remaining unmarried or relationship instability.<br>';
      }

      // Additional BNN-based conditions
      const ketuSign = horoscope['Ketu']?.sign;
      const rahuSign = horoscope['Rahu']?.sign;
      const saturnSign = horoscope['Saturn']?.sign;

      // Venus in 4/6/8/10 from Jupiter
      const venusFromJupiter = (venusSign - jupiterSign + 12) % 12;
      if ([3, 5, 7, 9].includes(venusFromJupiter)) {
        outcome += '⚠️ Venus in 4/6/8/10 from Jupiter — delays or disruption in marriage.<br>';
      }

      // Ketu in 1/5/9/2 from Venus
      const ketuFromVenus = (ketuSign - venusSign + 12) % 12;
      if ([0, 4, 8, 1].includes(ketuFromVenus)) {
        outcome += '⚠️ Ketu in 1st/5th/9th/2nd from Venus — spiritual detachment or denial in relationships.<br>';
      }

      // 7th lord from Jupiter in 4/6/8/10 from Jupiters lord
      const jupiter7thLord = getSignLord(seventhFromJupiter);
      const jupiter7thLordSign = horoscope[jupiter7thLord]?.sign;
      const posFromJLord = (jupiter7thLordSign - jupiterLordSign + 12) % 12;
      if ([3, 5, 7, 9].includes(posFromJLord)) {
        outcome += '⚠️ Jupiters 7th lord ' + jupiter7thLord + ' in 4/6/8/10 from Jupiters lord ' + jupiterLord + ' — obstruction in marital harmony.<br>';
      }

      // Ketu in 1/5/9/2 from Jupiters 7th lord
      const ketuFromJup7th = (ketuSign - jupiter7thLordSign + 12) % 12;
      if ([0, 4, 8, 1].includes(ketuFromJup7th)) {
        outcome += '⚠️ Ketu afflicting Jupiters 7th lord — difficulty in commitment or detachment from spouse.<br>';
      }

      // Sequence: Jupiter + Ketu + Venus or Venus + Ketu + Jupiter
      const seq = [jupiterSign, ketuSign, venusSign];
      const seqAlt = [venusSign, ketuSign, jupiterSign];
      const ordered = (a, b, c) => ((a + 1) % 12 === b % 12 && (b + 1) % 12 === c % 12);
      if (ordered(...seq) || ordered(...seqAlt)) {
        outcome += '⚠️ Jupiter, Ketu, and Venus in successive signs — high chance of divorce or no progeny.<br>';
      }

      // Sequence: Jupiters lord + Ketu + Jupiters 7th lord or reverse
      const seq2 = [jupiterLordSign, ketuSign, jupiter7thLordSign];
      const seq2Alt = [jupiter7thLordSign, ketuSign, jupiterLordSign];
      if (ordered(...seq2) || ordered(...seq2Alt)) {
        outcome += '⚠️ Jupiters lord, Ketu, and 7th lord in sequence — breakup or denial of marriage/progeny.<br>';
      }

      // Venus hemmed between Rahu and Ketu
      if ((rahuSign < venusSign && venusSign < ketuSign) || (ketuSign < venusSign && venusSign < rahuSign)) {
        outcome += '⚠️ Venus hemmed between Rahu and Ketu — marriage not promised unless Jupiter aspects Venus.<br>';
      }

      // Saturn aspects Venus (7th from Saturn)
      const saturnAspects = ((saturnSign + 6) % 12) + 1;
      if (saturnAspects === venusSign) {
        outcome += '⚠️ Saturn aspects Venus — marriage may be delayed significantly.<br>';
      }

      // --- Spouse Health / Widowhood Checks ---
      // Mars for female, check 1/2/5/9 from Rahu
      const marsFromRahu = (marsSign - rahuSign + 12) % 12;
      if ([0, 1, 4, 8].includes(marsFromRahu)) {
        outcome += '⚠️ Mars (females spouse indicator) is in 1st/2nd/5th/9th from Rahu — possible threat to spouses health or early death.<br>';
      }

      // Mars hemmed between Rahu and Saturn (direction-wise)
      if ((rahuSign < marsSign && marsSign < saturnSign) || (saturnSign < marsSign && marsSign < rahuSign)) {
        outcome += '⚠️ Mars hemmed between Rahu and Saturn — can indicate widowhood or loss of spouse. As the combination denotes accidents or accidental death or major health problems like heart at ache or cancer or unnatural death to her husband<br>';
      }

      const div = document.getElementById("results");
      div.insertAdjacentHTML('afterbegin', `<p>Female Marriage :<br><strong>${outcome}</strong></p>`);
      return outcome || '⚠️ No strong marriage indicators found based on Mars and Jupiter analysis.';

    }

    function getMarriageOutcomeForMale(horoscope) {
      const venusSign = horoscope['Venus']?.sign;
      const jupiterSign = horoscope['Jupiter']?.sign;
      const marsSign = horoscope['Mars']?.sign;

      if (!venusSign || !jupiterSign || !marsSign) return 'Insufficient data to analyze marriage outcome.';

      let outcome = '';

      const getSignLord = sign => {
        const lords = {
          1: 'Mars', 2: 'Venus', 3: 'Mercury', 4: 'Moon', 5: 'Sun', 6: 'Mercury',
          7: 'Venus', 8: 'Mars', 9: 'Jupiter', 10: 'Saturn', 11: 'Saturn', 12: 'Jupiter'
        };
        return lords[sign];
      };

      const distance = (venusSign - jupiterSign + 12) % 12;
      if ([1, 2, 3, 5, 7, 9, 11].includes(distance)) {
        outcome += '✅ Marriage is promised based on Venus-Jupiter positioning.<br>';
      } else if ([4, 6, 8, 10].includes(distance)) {
        outcome += '⚠️ Marriage obstacles indicated due to Venus in bad houses from Jupiter.<br>';
      }

      const venusDegree = horoscope['Venus']?.degree || 0;
      const jupiterDegree = horoscope['Jupiter']?.degree || 0;
      const marsDegree = horoscope['Mars']?.degree || 0;
      const ketuSign = horoscope['Ketu']?.sign;
      const rahuSign = horoscope['Rahu']?.sign;
      const saturnSign = horoscope['Saturn']?.sign;

      const jupiterLord = getSignLord(jupiterSign);
      const jupiterLordSign = horoscope[jupiterLord]?.sign;
      const seventhFromJupiter = ((jupiterSign + 6 - 1) % 12) + 1;
      const seventhFromJLord = ((jupiterLordSign + 6 - 1) % 12) + 1;

      const jupiter7thLord = getSignLord(seventhFromJupiter);
      const jupiter7thLordSign = horoscope[jupiter7thLord]?.sign;

      // Jupiters 7th lord placement
      const posFromJLord = (jupiter7thLordSign - jupiterLordSign + 12) % 12;
      if ([1, 2, 3, 5, 7, 9, 11].includes(posFromJLord)) {
        outcome += '✅ Jupiters 7th lord is well placed — favorable for marriage.<br>';
      } else {
        outcome += '⚠️ Jupiters 7th lord is not ideally placed — possible delay or disruption.<br>';
      }

      // Venus-Mars conjunction tight
      if ((venusSign === marsSign) && Math.abs(venusDegree - marsDegree) <= 1) {
        outcome += '⚠️ Venus conjunct Mars — possible friction, passionate but unstable marriage.<br>';
      }

      // Venus heavily afflicted by malefics
      const malefics = ['Saturn', 'Rahu', 'Ketu'];
      const maleficInfluence = malefics.filter(m => horoscope[m]?.sign === venusSign).length;
      if (maleficInfluence >= 2) {
        outcome += '⚠️ Venus heavily afflicted — risk of separation or not getting married.<br>';
      }

      // Venus in 4/6/8/10 from Jupiter
      const venusFromJupiter = (venusSign - jupiterSign + 12) % 12;
      if ([3, 5, 7, 9].includes(venusFromJupiter)) {
        outcome += '⚠️ Venus in 4/6/8/10 from Jupiter — delays or disruption in marriage.<br>';
      }

      // Ketu in 1/5/9/2 from Venus
      const ketuFromVenus = (ketuSign - venusSign + 12) % 12;
      if ([0, 4, 8, 1].includes(ketuFromVenus)) {
        outcome += '⚠️ Ketu in 1st/5th/9th/2nd from Venus — detachment or loss in relationship matters.<br>';
      }

      // Jupiters 7th lord in 4/6/8/10 from Jupiters lord
      if ([3, 5, 7, 9].includes(posFromJLord)) {
        outcome += '⚠️ Jupiters 7th lord ' + jupiter7thLord + ' in 4/6/8/10 from its lord ' + jupiterLord + ' — challenge to long-term marriage.<br>';
      }

      // Ketu in 1/5/9/2 from Jupiters 7th lord
      const ketuFromJup7th = (ketuSign - jupiter7thLordSign + 12) % 12;
      if ([0, 4, 8, 1].includes(ketuFromJup7th)) {
        outcome += '⚠️ Ketu afflicting Jupiters 7th lord — instability or emotional detachment.<br>';
      }

      // Sequences Venus + Ketu + Jupiter or reverse
      const seq = [venusSign, ketuSign, jupiterSign];
      const seqAlt = [jupiterSign, ketuSign, venusSign];
      const ordered = (a, b, c) => ((a + 1) % 12 === b % 12 && (b + 1) % 12 === c % 12);
      if (ordered(...seq) || ordered(...seqAlt)) {
        outcome += '⚠️ Venus, Ketu, and Jupiter in successive signs — risk of no marriage or divorce.<br>';
      }

      // Jupiters lord + Ketu + 7th lord or reverse
      const seq2 = [jupiterLordSign, ketuSign, jupiter7thLordSign];
      const seq2Alt = [jupiter7thLordSign, ketuSign, jupiterLordSign];
      if (ordered(...seq2) || ordered(...seq2Alt)) {
        outcome += '⚠️ Jupiters lord, Ketu and 7th lord in sequence — major relationship challenges.<br>';
      }

      // Venus hemmed between Rahu and Mars/Saturn (direction-wise)
      const venusHemmed = (
        (rahuSign < venusSign && venusSign < marsSign) || (marsSign < venusSign && venusSign < rahuSign) ||
        (rahuSign < venusSign && venusSign < saturnSign) || (saturnSign < venusSign && venusSign < rahuSign) ||
        (marsSign < venusSign && venusSign < saturnSign) || (saturnSign < venusSign && venusSign < marsSign)
      );
      if (venusHemmed) {
        outcome += '⚠️ Venus hemmed between malefics —  the combination denotes accidents or accidental and Saturn(Direction Wise), the combination denotes accidents or accidental death or major health problems like heart at ache or cancer or unnatural death death or major health problems like heart at ache or cancer or unnatural death to wife.<br>';
      }

      // Venus hemmed between Rahu and Mars/Saturn (direction-wise)
      const venusHemmedMalefic = (
        (rahuSign < venusSign && venusSign < ketuSign) || (ketuSign < venusSign && venusSign < rahuSign)
      );
      const jupiterAspectOnVenus = [4, 6, 8].includes((venusSign - jupiterSign + 12) % 12);

      if (venusHemmedMalefic) {
        if (jupiterAspectOnVenus) {
          outcome += '⚠️ Venus hemmed between Rahu and Ketu — but Jupiters aspect nullifies this dosha, early marriage possible.<br>';
        } else {
          outcome += '❌ Venus hemmed between Rahu and Ketu — marriage not promised unless Jupiter aspects Venus.<br>';
        }
      }

      // Venus in 1st/2nd/5th/9th from Rahu (threat to spouse)
      const venusFromRahu = (venusSign - rahuSign + 12) % 12;
      if ([0, 1, 4, 8].includes(venusFromRahu)) {
        outcome += '⚠️ Venus in 1/2/5/9 from Rahu — risk to spouse health or longevity.<br>';
      }

      // Venus hemmed between Rahu and Mars, or Rahu and Saturn, or Mars and Saturn (direction-wise)
      const venusHemmedAccident = (
        (rahuSign < venusSign && venusSign < marsSign) || (marsSign < venusSign && venusSign < rahuSign) ||
        (rahuSign < venusSign && venusSign < saturnSign) || (saturnSign < venusSign && venusSign < rahuSign) ||
        (marsSign < venusSign && venusSign < saturnSign) || (saturnSign < venusSign && venusSign < marsSign)
      );
      if (venusHemmedAccident) {
        outcome += '❗ Venus hemmed between malefics (Rahu, Mars, Saturn) — potential for accidents, major illness, or unnatural death of spouse.<br>';
      }

      // Jupiter aspects Venus (5th, 7th, 9th aspects)
      const diffJV = (venusSign - jupiterSign + 12) % 12;
      if ([4, 6, 8].includes(diffJV)) {
        outcome += '✅ Jupiter aspects Venus — early or blessed marriage indicated.<br>';
      }

      // Saturn aspects Venus (3rd, 7th, 10th aspects)
      const diffSV = (venusSign - saturnSign + 12) % 12;
      if ([2, 6, 9].includes(diffSV)) {
        outcome += '⚠️ Saturn aspects Venus — marriage likely delayed and requires patience.<br>';
      }
      const div = document.getElementById("results");
      div.insertAdjacentHTML('afterbegin', `<p>Male Marriage :<br><strong>${outcome}</strong></p>`);

      return outcome || '⚠️ No strong marriage indicators found based on Venus and Jupiter analysis.';
    }

    // Save horoscope to local storage with a name
    function saveHoroscopeWithName(name, horoscope) {
      const all = JSON.parse(localStorage.getItem('bnnHoroscopes') || '{}');
      all[name] = horoscope;
      localStorage.setItem('bnnHoroscopes', JSON.stringify(all));
      updateHoroscopeDropdown();
    }

    // Load horoscope from local storage by name
    function loadHoroscopeByName(name) {
      const all = JSON.parse(localStorage.getItem('bnnHoroscopes') || '{}');
      const horoscope = all[name];
      if (horoscope) {
        Object.entries(horoscope).forEach(([planet, data, house]) => {
          const signEl = document.getElementById(`${planet}-sign`);
          const degEl = document.getElementById(`${planet}-deg`);
          const houseE1 = document.getElementById(`${planet}-house`);
          const retrogradeEl = document.getElementById(`${planet}-retrograde`);
          if (retrogradeEl) {
            retrogradeEl.checked = data.retrograde || false;
          }
          if (signEl && degEl) {
            signEl.value = data.sign;
            degEl.value = data.degree;
            houseE1.value = data.house;
          }
        });
        document.getElementById('horoscope-name').value = name;
      }
    }

    // Update the dropdown options with saved horoscopes
    function updateHoroscopeDropdown() {
      const all = JSON.parse(localStorage.getItem('bnnHoroscopes') || '{}');
      const dropdown = document.getElementById('horoscope-select');
      dropdown.innerHTML = '<option value="">-- Select Saved Horoscope --</option>';
      Object.keys(all).forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        dropdown.appendChild(opt);
      });
    }

    // Interpret a conjunction using living/non-living and sign traits
    function interpretConjunction(planets, sign, data) {
      const planetData = data.planets;
      const signData = data.zodiac_signs.find(z => z.sign === sign);

      const livingTraits = [];
      const nonLivingTraits = [];

      planets.forEach((p, idx) => {
        const pData = planetData.find(x => x.name === p);
        if (!pData || !pData.characteristics?.significators?.length) return;
        const sigs = pData.characteristics.significators;
        if (idx === 0) {
          livingTraits.push(...sigs.filter(s => !s.toLowerCase().includes("karma")));
        } else {
          nonLivingTraits.push(...sigs.filter(s => s.length < 30));
        }
      });

      const signTraits = signData?.characteristics || [];
      //signData?.characteristics?.slice(0, 3) || [];
      const subject = livingTraits[0] || 'Someone';
      const effect = nonLivingTraits[0] || 'some outcome';
      const field = signTraits[0] || 'some area';

      let combinations = [];
      livingTraits.forEach(subject => {
        nonLivingTraits.forEach(effect => {
          signTraits.forEach(field => {
            combinations.push(`${subject} experiences ${effect} in ${field} (Sign: ${sign})`);
          });
        });
      });
      return combinations.length ? combinations : [`${subject} experiences ${effect} in ${field} (Sign: ${sign})`];
    }

    // Batch interpret all conjunctions and display
    function interpretAllConjunctions(horoscope, data) {
      const results = {};
      const signMap = {};

      Object.entries(horoscope).forEach(([planet, { sign }]) => {
        if (!signMap[sign]) signMap[sign] = [];
        signMap[sign].push(planet);
      });

      Object.entries(signMap).forEach(([sign, planets]) => {
        if (planets.length > 1) {
          for (let i = 0; i < planets.length; i++) {
            for (let j = i + 1; j < planets.length; j++) {
              const pairKey = `${planets[i]} & ${planets[j]} in ${sign}`;
              results[pairKey] = interpretConjunction([planets[i], planets[j]], signs[sign - 1], data);
            }
          }
        }
      });

      const container = document.createElement('div');
      container.style.display = 'flex';
      container.style.flexWrap = 'wrap';
      container.style.gap = '16px';
      container.style.marginTop = '20px';

      Object.entries(results).forEach(([key, msgs]) => {
        const card = document.createElement('div');
        card.style.border = '1px solid #ccc';
        card.style.padding = '12px';
        card.style.borderRadius = '8px';
        card.style.background = '#f9f9f9';
        //card.style.width = '300px';

        const title = document.createElement('h4');
        title.textContent = key;
        card.appendChild(title);

        const list = document.createElement('ul');
        msgs.forEach(msg => {
          const li = document.createElement('li');
          li.textContent = msg;
          list.appendChild(li);
        });
        card.appendChild(list);
        container.appendChild(card);
      });

      const outputTarget = document.createElement('div');
      outputTarget.id = 'interpretationCont';
      outputTarget.scrollIntoView({ behavior: 'smooth' });
      //outputTarget.innerHTML = '';
      outputTarget.appendChild(container);
      const toggleContainer = document.createElement('div');
      toggleContainer.style.marginTop = '10px';
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = 'toggle-output';
      checkbox.checked = "checked";
      checkbox.addEventListener('change', () => {
        outputTarget.style.display = checkbox.checked ? 'block' : 'none';
        console.log('Visibility', outputTarget.style.display);
      });
      const label = document.createElement('label');
      label.htmlFor = 'toggle-output';
      label.textContent = ' Show Interpretations';
      toggleContainer.appendChild(checkbox);
      toggleContainer.appendChild(label);
      toggleContainer.appendChild(outputTarget);
      const div = document.getElementById("results");
      div.insertAdjacentHTML('afterbegin', toggleContainer.innerHTML);
      console.log('interpretAllConjunctions', results);

      document.getElementById('toggle-output').addEventListener('change', () => {
        document.getElementById('interpretationCont').style.display = this.checked ? 'block' : 'none';
        console.log('Visibility', this.checked, document.getElementById('interpretationCont').style.display);
      });
      return Object.keys(results);
    }

    // Example usage:
    // const output = interpretAllConjunctions(horoscope, property);
    // output.forEach(msg => console.log(msg));

    // Find placement of sign lords in houses
    function getSignLordPlacements(horoscope) {
      const signLords = {
        1: 'Mars', 2: 'Venus', 3: 'Mercury', 4: 'Moon', 5: 'Sun', 6: 'Mercury',
        7: 'Venus', 8: 'Mars', 9: 'Jupiter', 10: 'Saturn', 11: 'Saturn', 12: 'Jupiter'
      };

      const placements = {};
      for (let sign = 1; sign <= 12; sign++) {
        const lord = signLords[sign];
        const planetData = horoscope[lord];
        if (planetData && planetData.house) {
          placements[`Sign ${sign}`] = `${lord}:  ${getHouseOfSign(sign, horoscope)} house lord is placed in House ${planetData.house}`;
        } else {
          placements[`Sign ${sign}`] = `${lord} not found or house not defined in chart`;
        }
      }
      return placements;
    }

    const getHouseOfSign = (sign, horoscope) => {
      const entry = Object.values(horoscope).find(p => p.sign === sign);
      return entry?.house || null;
    };
    // Add button to show sign lord placements
    function showSignLordPlacements(horoscope) {
      const placements = getSignLordPlacements(horoscope);

      let placementContainer = document.getElementById('lord-placement-results');
      if (!placementContainer) {
        placementContainer = document.createElement('div');
        placementContainer.id = 'lord-placement-results';
        placementContainer.style.marginTop = '20px';
        document.body.appendChild(placementContainer);
      }
      placementContainer.innerHTML = '';
      const list = document.createElement('ul');
      Object.entries(placements).forEach(([sign, msg]) => {
        const li = document.createElement('li');
        li.textContent = msg;
        list.appendChild(li);
      });
      placementContainer.appendChild(list);
      const div = document.getElementById("results");
      div.insertAdjacentHTML('afterbegin', `${placementContainer.innerHTML}`);

    }

    // Determine profession from horoscope
    function getProfessionFromHoroscope(horoscope) {
      const saturn = horoscope['Saturn'];
      if (!saturn) return 'Saturn not found in chart';

      const rashiProfessions = {
        1: 'Govt. job, Police, Military Service, Engineering, Agriculture, Construction',
        2: 'Fine Arts, Banking, Finance, Insurance, Share Market, Jewelry',
        3: 'Journalism, Media, Marketing, Teaching, Tutoring',
        4: 'Food, Travel, Marine, Economics, Navy, Hospitality',
        5: 'CEO, Manager, Govt. Authority, Team Lead, HR',
        6: 'Law, Astrology, Consulting, Agriculture, Village Admin',
        7: 'Medicine, Law, Banking, Finance, Arts',
        8: 'Engineering, Surgery, Machinery, Research, Coding',
        9: 'Teaching, Consulting, Banking, Management',
        10: 'CA, Professor, IAS, UPSC, Neurosurgeon',
        11: 'Psychologist, Consultant, Telecom, Navy, CBI',
        12: 'Aviation, Auto, International Travel, Foreign Work'
      };

      const prof = rashiProfessions[saturn.sign];
      let extras = [];

      // Get aspects: 3rd, 7th, 10th, and trine (1, 5, 9) signs from Saturn
      const aspectSigns = [
        (saturn.sign + 2) % 12 || 12,
        (saturn.sign + 6) % 12 || 12,
        (saturn.sign + 9) % 12 || 12,
        saturn.sign,
        (saturn.sign + 4) % 12 || 12,
        (saturn.sign + 8) % 12 || 12
      ];

      // If retrograde, calculate trine signs from the sign preceding Saturn's sign
      if (saturn.retrograde) {
        const previousSign = (saturn.sign - 1 + 12) % 12 || 12;
        aspectSigns.push(
          previousSign,
          (previousSign + 4) % 12 || 12,
          (previousSign + 8) % 12 || 12
        );
      }

      const influenceDetails = Object.entries(horoscope)
        .filter(([p, d]) => p !== 'Saturn' && aspectSigns.includes(d.sign))
        .map(([p, d]) => {
          const diff = (d.sign - saturn.sign + 12) % 12;
          let aspectType = '';
          if (d.sign === saturn.sign) aspectType = 'Conjunction';
          else if (diff === 2) aspectType = '3rd aspect';
          else if (diff === 6) aspectType = '7th aspect';
          else if (diff === 9) aspectType = '10th aspect';
          else if (diff === 4 || diff === 8) aspectType = 'Trine';
          else if (saturn.retrograde && [
            (saturn.sign - 1 + 12) % 12 || 12,
            (saturn.sign - 1 + 4 + 12) % 12 || 12,
            (saturn.sign - 1 + 8 + 12) % 12 || 12
          ].includes(d.sign)) aspectType = 'Retrograde Trine';
          return `${p} (${aspectType})`;
        });

      const planetHints = {
        Sun: 'Name , Fame,Recognition in profession, High paid Job, Higher rank, Authority, Would be unsatisfied with low esteem job, Govt. Job, Politics, MBA, Hospital, Establishing Planet.',
        Moon: 'Food Business, Grocery Store, Mo+Ra(Kirana store, Wholesale store), Tours and travel company, transferrable Govt./Private job, Navy, chemistry, economics, Liquor, Coldrinks, water related, Changes , up-down , travels in profession.',
        Mars: 'Engineering, Technical skills, ITI, Army, Defense Forces, Police, Surgeon, Dentist, Construction Work, Real Estate, B.com, Accountant, Electronics, Vastu',
        Mercury: 'Business, Education, Journalism, Mathematics',
        Venus: ' Money, Assets, Vehicles , Bank, Finances, Insurance, Trading, Fine Arts, Garments, Utensils, Home Décor, Designing, smoothness in profession.',
        Jupiter: 'Helps in Law education, Teacher, B.Ed. , Well educated, can always study, social work, CA, consultant, bank',
        Rahu: 'Software Engineer, MNC, Shadow and unethical work(Betting etc.), Profession in foreign land, digital marketing, export import, person is extremely intelligent',
        Ketu: 'Coding, Yoga teacher, spiritual guru, astrologer, occult, vastu , Surgery , Law, Low skilled jobs(Tailor, barber, painter etc.) Native is not happy with Job and wants to do something of his own.'
      };

      influenceDetails.forEach(detail => {
        const name = detail.split(' ')[0];
        if (planetHints[name]) extras.push(planetHints[name]);
      });

      const aspectsText = influenceDetails.length ? `

      Aspecting planets: ${influenceDetails.join(', ')}` : '';
      return `Saturn in sign ${saturn.sign}: ${prof}.

      Additional indicators: ${extras.join(' , ') || 'None'}${aspectsText}`;
    }

    // Show career insights from Saturn
    function showProfessionFromHoroscope(horoscope) {
      const professionText = getProfessionFromHoroscope(horoscope);
      let card = document.getElementById('profession-card');
      if (!card) {
        card = document.createElement('div');
        card.id = 'profession-card';
        card.style.border = '2px solid #0066cc';
        card.style.padding = '12px';
        card.style.borderRadius = '8px';
        card.style.background = '#e6f0ff';
        card.style.marginTop = '20px';
        card.style.width = '100%';
        document.getElementById('results')?.prepend(card);
      } else {
        card.innerHTML = '';
      }
      const title = document.createElement('h3');
      title.textContent = 'Career Insights based on Saturn';
      const para = document.createElement('p');
      para.textContent = professionText;
      card.appendChild(title);
      card.appendChild(para);
    }

    function getWorkEnvironmentFromHoroscope(horoscope) {
      const saturn = horoscope['Saturn'];
      if (!saturn || !saturn.sign) return 'Saturn sign not found.';

      const twelfthSign = (saturn.sign + 11) % 12 || 12;
      const twelfthHousePlanets = Object.entries(horoscope)
        .filter(([p, d]) => d.sign === twelfthSign)
        .map(([p]) => p);

      const goodPlanets = ['Venus', 'Jupiter', 'Sun', 'Mercury'];
      const badPlanets = ['Mars', 'Rahu', 'Ketu'];

      const good = twelfthHousePlanets.filter(p => goodPlanets.includes(p));
      const bad = twelfthHousePlanets.filter(p => badPlanets.includes(p));

      let result = `12th from Saturn is Sign ${twelfthSign}.`;
      if (twelfthHousePlanets.length === 0) {
        result += `\nNo planets in the 12th from Saturn — neutral work environment.`;
      } else {
        result += `\nPlanets in 12th from Saturn: ${twelfthHousePlanets.join(', ')}`;
        if (bad.length) {
          result += `\n⚠️ Not good work environment due to: ${bad.join(', ')}`;
        }
        if (good.length) {
          result += `\n✅ Enjoyable work environment due to: ${good.join(', ')}`;
        }
      }

      if (twelfthHousePlanets.length && saturn.retrograde) {
        result += `\n🌀 Since Saturn is retrograde, profession may be out of compulsion or external pressure.`;
      }
      const div = document.getElementById("results");
      div.insertAdjacentHTML('afterbegin', `${result}`);
      return result;
    }

    // Attach save and load UI components
    window.addEventListener('DOMContentLoaded', () => {
      const container = document.createElement('div');
      container.innerHTML = `
    <input type="text" id="horoscope-name" placeholder="Enter name to save horoscope" />
    <button onclick="const name = document.getElementById('horoscope-name').value.trim(); if(name){ saveHoroscopeWithName(name, nativeHoroscope); }">Save Horoscope</button>
    <select id="horoscope-select" onchange="if(this.value) loadHoroscopeByName(this.value)"></select>
  `;
      document.body.insertBefore(container, document.getElementById('inputForm'));
      updateHoroscopeDropdown();
    });
  </script>
</body>

</html>